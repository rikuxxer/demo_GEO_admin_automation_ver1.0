# 権限管理仕様書（セキュリティ部門向け）

## 文書情報

| 項目 | 内容 |
|------|------|
| **文書名** | 権限管理仕様書 |
| **対象読者** | セキュリティ部門、システム管理者 |
| **バージョン** | 1.0 |
| **最終更新日** | 2025-01-13 |
| **作成者** | 開発チーム |

---

## 目次

1. [概要](#概要)
2. [認証方式](#認証方式)
3. [ユーザーロール定義](#ユーザーロール定義)
4. [権限マトリックス](#権限マトリックス)
5. [データアクセス制御](#データアクセス制御)
6. [セキュリティ対策](#セキュリティ対策)
7. [監査とログ](#監査とログ)
8. [リスク評価](#リスク評価)
9. [付録](#付録)

---

## 概要

### システム概要

UNIVERSEGEO案件管理システムは、位置情報データ（POI）と広告配信案件を管理するWebアプリケーションです。

### 権限管理の目的

- **データの機密性保護**: 営業担当者が他の担当者の進行中案件にアクセスできないようにする
- **データの整合性保護**: 適切な権限を持つユーザーのみがデータを変更できるようにする
- **業務分離**: 営業と管理部門の役割を明確に分離する
- **監査可能性**: 誰が何をいつ実行したかを追跡可能にする

### 権限管理の原則

1. **最小権限の原則**: ユーザーには業務に必要な最小限の権限のみを付与
2. **役割ベースアクセス制御（RBAC）**: ロールに基づいて権限を管理
3. **データレベルアクセス制御**: ロールだけでなく、データの所有権に基づく制御
4. **明示的な拒否**: 権限がない場合は明示的にアクセスを拒否

---

## 認証方式

### 認証フロー

認証フロー:

    [ユーザー] → [ログイン画面] → [認証処理] → [セッション確立] → [権限チェック]

### 認証方法

#### 1. パスワード認証

- **方式**: Base64エンコード（開発環境）
- **本番環境**: 適切なハッシュ化アルゴリズム（bcrypt等）への移行が必要
- **パスワード要件**: 
  - 最小8文字（推奨）
  - 大文字・小文字・数字・記号の組み合わせ（推奨）

#### 2. セッション管理

- **ストレージ**: ブラウザのLocalStorage（本番環境ではHttpOnly Cookieへの移行を推奨）
- **セッション有効期限**: ブラウザを閉じるまで（明示的なログアウトまで）
- **セッション情報**: ユーザーID、ロール、メールアドレス

#### 3. 認証状態の保持

認証情報の保存場所（TypeScriptコード）:

    localStorage.setItem('currentUser', JSON.stringify({
      id: string,
      name: string,
      email: string,
      role: 'admin' | 'sales',
      department?: string
    }));

### セキュリティ上の注意事項

【重要】現在の実装では以下の点に注意が必要です：

1. **パスワード保存**: Base64エンコードは暗号化ではないため、本番環境では適切なハッシュ化が必要
2. **セッション管理**: LocalStorageはXSS攻撃に対して脆弱なため、HttpOnly Cookieへの移行を推奨
3. **CSRF対策**: 現在の実装ではCSRFトークンが未実装

---

## ユーザーロール定義

### ロール一覧

システムでは以下の2つのロールが定義されています：

| ロールID | ロール名 | 説明 | 想定ユーザー |
|---------|---------|------|------------|
| admin | 管理者 | すべての機能にアクセス可能 | 管理部門スタッフ |
| sales | 営業 | 案件管理機能にアクセス可能 | 営業担当者 |

### ロールの詳細

#### 管理者（admin）

**役割**: システム全体の管理と運用

**主な業務**:
- 全案件の閲覧・管理
- 案件ステータスの変更
- セグメントステータスの変更
- ユーザー管理（登録・承認・無効化）
- 編集リクエストの承認・却下
- システム設定の変更

#### 営業（sales）

**役割**: 案件の登録と管理

**主な業務**:
- 案件の作成・編集
- セグメントの作成・編集
- 地点情報の登録・編集
- 自分の担当案件の管理
- 編集リクエストの作成・取り下げ
- 連携完了案件の閲覧（他の営業の案件も含む）

---

## 権限マトリックス

### 機能別権限一覧

| 機能 | 管理者 | 営業 | 備考 |
|------|--------|------|------|
| **ダッシュボード** |
| 管理者ダッシュボード表示 | [可] | [不可] | 管理者専用 |
| 案件一覧表示 | [可] | [可] | 営業は閲覧権限のある案件のみ |
| **案件管理** |
| 案件作成 | [可] | [可] | 全ユーザー可能 |
| 案件編集 | [可] | [可] | 営業は自分の担当案件のみ |
| 案件削除 | [可] | [不可] | 管理者のみ |
| 全案件閲覧 | [可] | [条件付き] | 営業は条件付き（後述） |
| **セグメント管理** |
| セグメント作成 | [可] | [可] | 全ユーザー可能 |
| セグメント編集 | [可] | [可] | 営業は自分の担当案件のみ |
| セグメント削除 | [可] | [不可] | 管理者のみ |
| **地点管理** |
| 地点作成 | [可] | [可] | 全ユーザー可能 |
| 地点編集 | [可] | [可] | 営業は自分の担当案件のみ |
| 地点削除 | [可] | [条件付き] | 営業は下書き状態のみ |
| **ステータス管理** |
| 案件ステータス変更 | [可] | [不可] | 管理者のみ |
| セグメントステータス変更 | [可] | [不可] | 管理者のみ |
| **ユーザー管理** |
| ユーザー登録申請 | [可] | [可] | 全ユーザー可能 |
| ユーザー承認 | [可] | [不可] | 管理者のみ |
| ユーザー無効化 | [可] | [不可] | 管理者のみ |
| ユーザー一覧表示 | [可] | [不可] | 管理者のみ |
| **編集リクエスト** |
| 編集リクエスト作成 | [可] | [可] | 営業は自分の担当案件のみ |
| 編集リクエスト承認 | [可] | [不可] | 管理者のみ |
| 編集リクエスト却下 | [可] | [不可] | 管理者のみ |
| 編集リクエスト取り下げ | [可] | [可] | 作成者のみ、承認待ちのみ |
| **スプレッドシート出力** |
| 自動出力 | [可] | [可] | 営業は自分の担当案件のみ |
| 手動エクスポート | [可] | [不可] | 管理者のみ |

### 権限定義（コード）

権限定義（TypeScriptコード、ファイル: src/types/auth.ts）:

    export const ROLE_PERMISSIONS = {
      admin: {
        canViewAdminDashboard: true,
        canManageProjectStatus: true,
        canManageSegmentStatus: true,
        canCreateProject: true,
        canEditProject: true,
        canDeleteProject: true,
        canCreateSegment: true,
        canEditSegment: true,
        canDeleteSegment: true,
        canViewAllProjects: true,
        canManageUsers: true,
      },
      sales: {
        canViewAdminDashboard: false,
        canManageProjectStatus: false,
        canManageSegmentStatus: false,
        canCreateProject: true,
        canEditProject: true,
        canDeleteProject: false,
        canCreateSegment: true,
        canEditSegment: true,
        canDeleteSegment: false,
        canViewAllProjects: true,  // 条件付き（後述）
        canManageUsers: false,
      },
    } as const;

---

## データアクセス制御

### 案件データのアクセス制御

#### 閲覧権限（canViewProject）

**実装ファイル**: src/utils/editRequest.ts

**ルール**:

1. **管理者（admin）**
   - [可] すべての案件を閲覧可能
   - [可] すべてのステータスで閲覧可能

2. **営業（sales）**
   - [可] **自分の担当案件**: すべてのステータスで閲覧可能
     - 主担当（person_in_charge）が自分の名前
     - または副担当（sub_person_in_charge）が自分の名前
   - [条件付き] **他の営業の案件**: 連携完了（linked）ステータスのみ閲覧可能
   - [不可] **他の営業の案件**: 下書き（draft）・進行中（in_progress）は閲覧不可

**実装コード**（TypeScript、ファイル: src/utils/editRequest.ts）:

    export function canViewProject(
      user: { role: string; name: string } | null,
      project: Project,
      projectStatus: string
    ): boolean {
      // 管理者は常に閲覧可能
      if (user?.role === 'admin') {
        return true;
      }
      
      // 営業の場合
      if (user?.role === 'sales') {
        // 自身が主担当または副担当の案件の場合、すべてのステータスで閲覧可能
        const isAssigned = 
          project.person_in_charge === user.name ||
          project.sub_person_in_charge === user.name;
        
        if (isAssigned) {
          return true;
        }
        
        // 他の営業の案件の場合、連携完了のみ閲覧可能
        return projectStatus === 'linked';
      }
      
      return false;
    }

#### 編集権限（canEditProject）

**実装ファイル**: src/utils/editRequest.ts

**ルール**:

1. **管理者（admin）**
   - [可] すべての案件を編集可能

2. **営業（sales）**
   - [可] **自分の担当案件**: 編集可能
     - 主担当（person_in_charge）が自分の名前
     - または副担当（sub_person_in_charge）が自分の名前
   - [不可] **他の営業の案件**: 編集不可

**実装コード**（TypeScript、ファイル: src/utils/editRequest.ts）:

    export function canEditProject(
      user: { role: string; name: string } | null,
      project: Project
    ): boolean {
      // 管理者は常に編集可能
      if (user?.role === 'admin') {
        return true;
      }
      
      // 営業の場合、自分の担当案件のみ編集可能
      if (user?.role === 'sales') {
        return (
          project.person_in_charge === user.name ||
          project.sub_person_in_charge === user.name
        );
      }
      
      return false;
    }

### セグメントデータのアクセス制御

セグメントは案件に紐づくため、案件の編集権限に従います。

- 案件の編集権限がある → セグメントの編集も可能
- 案件の編集権限がない → セグメントの編集も不可

### 地点データのアクセス制御

地点はセグメントに紐づくため、セグメント（案件）の編集権限に従います。

**追加制約**:
- 営業はセグメントのlocation_request_statusがnot_requestedの場合のみ地点を編集可能
- ステータスがstoringまたはcompletedの場合は編集リクエストが必要

### ユーザーデータのアクセス制御

- **管理者**: すべてのユーザー情報を閲覧・編集可能
- **営業**: ユーザー情報へのアクセス不可

### 編集リクエストのアクセス制御

| 操作 | 管理者 | 営業（作成者） | 営業（非作成者） |
|------|--------|---------------|-----------------|
| 作成 | [可] 全案件 | [可] 自分の担当案件のみ | [不可] |
| 承認 | [可] 全リクエスト | [不可] | [不可] |
| 却下 | [可] 全リクエスト | [不可] | [不可] |
| 取り下げ | [可] 全リクエスト | [可] 承認待ちのみ | [不可] |
| 閲覧 | [可] 全リクエスト | [可] 自分のリクエストのみ | [不可] |

---

## セキュリティ対策

### フロントエンド側の対策

#### 1. 権限チェックの実装

すべての機密操作において、フロントエンドとバックエンドの両方で権限チェックを実施。

**実装例**（TypeScript）:

    フロントエンド: ボタンの表示制御
    {hasPermission('canDeleteProject') && (
      <Button onClick={handleDelete}>削除</Button>
    )}

    フロントエンド: データフィルタリング
    const filteredProjects = projects.filter(project => 
      canViewProject(user, project, projectStatus)
    );

#### 2. ルート保護

認証されていないユーザーはログイン画面以外にアクセスできない。

**実装**（TypeScript、ファイル: src/App.tsx）:

    if (!isAuthenticated) {
      return <Login />;
    }

#### 3. コンポーネントレベルの保護

管理者専用コンポーネントは権限チェック後に表示。

**実装例**（TypeScript）:

    {hasPermission('canViewAdminDashboard') && (
      <AdminDashboard />
    )}

### バックエンド側の対策

【重要】現在の実装ではバックエンドAPIの権限チェックが不十分な可能性があります。

**推奨事項**:

1. **すべてのAPIエンドポイントで認証チェック**
2. **すべてのAPIエンドポイントで権限チェック**
3. **データアクセス制御の実装**
4. **レート制限の実装**
5. **入力値検証の強化**

### データベース側の対策

#### 1. データアクセス制御

BigQueryでは行レベルセキュリティ（RLS）の実装を検討。

#### 2. 監査ログ

すべてのデータ変更操作をログに記録（実装状況を確認が必要）。

### 通信のセキュリティ

- **HTTPS**: すべての通信はHTTPSで暗号化
- **CORS**: 適切なCORS設定（本番環境で確認が必要）

### セッション管理のセキュリティ

**現状の課題**:

1. LocalStorageの使用はXSS攻撃に対して脆弱
2. セッション有効期限の管理が不十分

**推奨改善**:

1. HttpOnly Cookieへの移行
2. セッションタイムアウトの実装
3. セッション固定化攻撃対策

---

## 監査とログ

### 現在のログ記録

#### 1. 認証ログ

- [実装済み] ログイン成功/失敗
- [実装済み] 最終ログイン時刻の更新
- [未確認] ログアウト時刻の記録（未確認）

#### 2. データ操作ログ

- [要確認] 案件の作成・更新・削除（実装状況を確認が必要）
- [要確認] セグメントの作成・更新・削除（実装状況を確認が必要）
- [要確認] 地点の作成・更新・削除（実装状況を確認が必要）

#### 3. 権限関連ログ

- [要確認] 権限チェック失敗の記録（実装状況を確認が必要）
- [要確認] 不正アクセス試行の記録（実装状況を確認が必要）

### 推奨される監査ログ項目

以下の情報を記録することを推奨：

| 項目 | 説明 | 必須度 |
|------|------|--------|
| ユーザーID | 操作を実行したユーザー | 必須 |
| 操作タイプ | 作成・更新・削除・閲覧 | 必須 |
| 操作対象 | 案件・セグメント・地点等 | 必須 |
| 操作対象ID | 具体的なリソースID | 必須 |
| 操作時刻 | タイムスタンプ | 必須 |
| IPアドレス | リクエスト元IP | 推奨 |
| ユーザーエージェント | ブラウザ情報 | 推奨 |
| 操作前の値 | 更新前のデータ（更新時） | 推奨 |
| 操作後の値 | 更新後のデータ（更新時） | 推奨 |
| 操作結果 | 成功・失敗 | 必須 |

### ログの保存期間

- **推奨**: 最低1年間
- **法的要件**: 業界規制に応じて調整

---

## リスク評価

### 高リスク項目

| リスク | 説明 | 影響度 | 対策 |
|--------|------|--------|------|
| パスワード保存方式 | Base64エンコードは暗号化ではない | 高 | 適切なハッシュ化への移行 |
| セッション管理 | LocalStorageはXSS攻撃に脆弱 | 高 | HttpOnly Cookieへの移行 |
| バックエンド権限チェック | 実装状況が不明 | 高 | バックエンドAPIの権限チェック実装 |
| CSRF対策 | 未実装の可能性 | 中 | CSRFトークンの実装 |

### 中リスク項目

| リスク | 説明 | 影響度 | 対策 |
|--------|------|--------|------|
| 監査ログ | 一部の操作が記録されていない可能性 | 中 | 包括的なログ記録の実装 |
| セッションタイムアウト | 未実装 | 中 | セッションタイムアウトの実装 |
| レート制限 | 未実装の可能性 | 中 | APIレート制限の実装 |

### 低リスク項目

| リスク | 説明 | 影響度 | 対策 |
|--------|------|--------|------|
| パスワード要件 | 弱いパスワードが許可される可能性 | 低 | パスワード強度チェックの実装 |

---

## 付録

### A. 権限チェック関数一覧

| 関数名 | ファイル | 説明 |
|--------|---------|------|
| hasPermission | src/contexts/AuthContext.tsx | ロールベースの権限チェック |
| canViewProject | src/utils/editRequest.ts | 案件閲覧権限チェック |
| canEditProject | src/utils/editRequest.ts | 案件編集権限チェック |
| canDirectEdit | src/utils/editRequest.ts | 直接編集可能かチェック |

### B. 案件IDの採番規則

#### 形式

案件IDは以下の形式で自動生成されます：

**形式**: `PRJ-{連番}`

**例**:
- PRJ-1
- PRJ-2
- PRJ-3
- PRJ-100

#### 生成ロジック

1. **既存案件の最大番号を取得**
   - データベース内の既存の案件IDから、`PRJ-` で始まり数字のみが続く形式（`PRJ-\d+`）のIDを検索
   - 数字部分の最大値を取得

2. **次の番号を計算**
   - 最大番号に +1 した値を次の案件IDとして使用
   - 案件が存在しない場合は `PRJ-1` から開始

3. **エラー時のフォールバック**
   - データベースアクセスエラーが発生した場合、タイムスタンプベースのID（`PRJ-{タイムスタンプ}`）を使用

#### 実装箇所

- **バックエンド**: `backend/src/bigquery-client.ts` の `generateNextProjectId()` 関数
- **フロントエンド**: `src/utils/bigquery.ts` の `createProject()` 関数内

#### 制約事項

- 案件IDは主キーとして使用されるため、重複は許可されない
- 案件IDの変更は不可（一度作成されたIDは変更できない）
- 削除された案件のIDは再利用されない（連番は継続）

#### 特殊な案件ID

以下の形式の案件IDは自動生成されません（手動で設定されたもの）：

- `PRJ-SAMPLE-{番号}`: サンプルデータ用
- `PRJ-DEMO-{番号}`: デモデータ用
- `PRJ-TEST-{番号}`: テストデータ用

これらは自動採番の対象外です。

### C. データベーススキーマ（ユーザー関連）

データベーススキーマ（SQL）:

    -- users テーブル
    CREATE TABLE universegeo_dataset.users (
      user_id STRING NOT NULL,
      name STRING NOT NULL,
      email STRING NOT NULL,
      password_hash STRING NOT NULL,
      role STRING NOT NULL,  -- 'admin' or 'sales'
      department STRING,
      is_active BOOL DEFAULT TRUE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
      last_login TIMESTAMP
    );

### D. 関連ドキュメント

- [システム仕様書](../src/docs/SYSTEM_SPECIFICATION.md)
- [案件閲覧権限仕様書](../src/docs/VIEW_PERMISSION_SPEC.md)
- [編集リクエスト承認仕様書](../src/docs/EDIT_REQUEST_APPROVAL_SPEC.md)
- [案件ID採番規則](../shared/PROJECT_ID_NUMBERING_RULES.md) - 案件IDの詳細な採番規則

### E. 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-01-13 | 1.0 | 初版作成 | 開発チーム |

---

## 連絡先

セキュリティに関する質問や懸念事項がある場合は、開発チームまでご連絡ください。
