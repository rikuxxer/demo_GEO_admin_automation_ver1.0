name: Deploy Backend to Cloud Run (Development)

on:
  push:
    branches:
      - develop
      - dev
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean

env:
  REGION: asia-northeast1
  SERVICE_NAME: universegeo-backend-dev

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Run (Development)
    runs-on: ubuntu-latest
    
    # é–‹ç™ºç’°å¢ƒç”¨ã®Environment secretsã‚’ä½¿ç”¨
    environment:
      name: development
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required secrets
        run: |
          echo "ðŸ” å¿…é ˆSecretsã®ç¢ºèªä¸­ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰..."
          echo "  Environment: development"
          echo ""
          
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ GCP_SA_KEY is missing"
            echo "   Settings > Environments > development > Secrets ã« GCP_SA_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          if [ -z "${{ secrets.BQ_DATASET }}" ]; then
            echo "âŒ BQ_DATASET is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] && [ -z "${{ vars.GCP_PROJECT_ID }}" ]; then
            echo "âŒ GCP_PROJECT_ID is missing"
            exit 1
          fi
          
          echo "âœ… å¿…é ˆSecretsãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ env.SERVICE_NAME }}
          source: ./backend
          region: ${{ env.REGION }}
          project_id: ${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
          
          env_vars_update_strategy: merge
          env_vars: |-
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
            BQ_DATASET=${{ secrets.BQ_DATASET }}
            GOOGLE_SPREADSHEET_ID=${{ secrets.GOOGLE_SPREADSHEET_ID }}
            GOOGLE_SHEETS_API_KEY=${{ secrets.GOOGLE_SHEETS_API_KEY }}
            GOOGLE_SHEET_NAME=${{ secrets.GOOGLE_SHEET_NAME || 'ã‚·ãƒ¼ãƒˆ1' }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL || 'http://localhost:5173' }}
            EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
            NODE_ENV=development
            DEBUG=true
            LOG_LEVEL=debug
            VERTEX_AI_LOCATION=${{ secrets.VERTEX_AI_LOCATION || 'us-central1' }}
            VERTEX_AI_MODEL=${{ secrets.VERTEX_AI_MODEL || 'gemini-2.0-flash-001' }}

          flags: >-
            --allow-unauthenticated
            --memory 512Mi
            --cpu 1
            --max-instances 5
          
          revision_traffic: 'LATEST=100'

      - name: Deployment Summary
        run: |
          echo "## âœ… Backend Deployment Successful (Development)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: development" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. é–‹ç™ºç’°å¢ƒã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "ðŸš€ Backend deployed to: ${{ steps.deploy.outputs.url }}"
