name: Production Deployment

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string
      version:
        description: 'Version or tag to deploy (optional)'
        required: false
        type: string

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  SERVICE_NAME: universegeo
  REPOSITORY: universegeo

jobs:
  verify-deployment:
    name: Verify Deployment Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Check confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DEPLOY" ]; then
            echo "âŒ Deployment not confirmed. Please type 'DEPLOY' to proceed."
            exit 1
          fi
          echo "âœ… Deployment confirmed"

      - name: Display deployment info
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "- **Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-production:
    name: Deploy to Production
    needs: verify-deployment
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://universegeo.run.app

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
          ref: ${{ github.event.inputs.version || github.sha }}

      - name: Verify Dockerfile
        run: |
          echo "ðŸ” Verifying Dockerfile..."
          if [ -d "Dockerfile" ]; then
            echo "âŒ CRITICAL: Dockerfile is a directory!"
            exit 1
          fi
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ CRITICAL: Dockerfile not found!"
            exit 1
          fi
          echo "âœ… Dockerfile verified"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: |
          echo "ðŸ” Running type check..."
          npm run type-check

      - name: Run lint
        run: |
          echo "ðŸ” Running lint..."
          npm run lint

      - name: Build application
        run: |
          echo "ðŸ—ï¸ Building application..."
          npm run build
          
          du -sh dist/
          echo "âœ… Build completed"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Build Docker image
        run: |
          IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:$GITHUB_SHA"
          IMAGE_LATEST="$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:latest"
          
          echo "ðŸ³ Building Docker image..."
          echo "Image: $IMAGE"
          
          docker build \
            --progress=plain \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=$GITHUB_SHA \
            -t $IMAGE \
            -t $IMAGE_LATEST \
            .
          
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV
          echo "âœ… Docker image built successfully"

      - name: Push Docker image to Artifact Registry
        run: |
          echo "ðŸ“¦ Pushing Docker images..."
          docker push $IMAGE
          docker push $IMAGE_LATEST
          echo "âœ… Images pushed successfully"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          echo "ðŸš€ Deploying to Cloud Run (PRODUCTION)..."
          
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --set-env-vars "NODE_ENV=production" \
            --tag "v-${GITHUB_SHA:0:7}"
          
          echo "âœ… Deployment completed"

      - name: Get deployment URL
        id: get-url
        run: |
          URL=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format 'value(status.url)')
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "DEPLOY_URL=$URL" >> $GITHUB_ENV

      - name: Deployment Summary
        run: |
          echo "## âœ… Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ‰ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ðŸ”´ Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: $REGION" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`$IMAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [$DEPLOY_URL]($DEPLOY_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Post-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify homepage loads correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test user authentication" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check key features" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Monitor error logs" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify database connectivity" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment notification
        run: |
          echo "::notice title=Production Deployment::âœ… Successfully deployed to $DEPLOY_URL"
