# UNIVERSEGEO コスト試算書

## サマリ

**月額合計コスト: 約 170,000円 ～ 200,000円**

### 主要コスト内訳
- **Google Maps Geocoding API**: 約 165,000円（最大コスト要因）
- **Cloud Run（フロントエンド + バックエンド）**: 約 3,000円 ～ 5,000円
- **BigQuery（ストレージ + クエリ）**: 約 1,500円 ～ 3,000円
- **Cloud Logging**: 約 500円 ～ 1,000円
- **Artifact Registry**: 約 100円
- **Google Sheets API**: 無料（クォータ内）
- **ネットワーク転送**: 約 500円 ～ 1,000円

---

## 前提条件

### 利用規模
- **利用人員数**: 50人
- **月間案件数**: 300件
- **月間地点数**: 300,000地点（1案件あたり1,000地点 × 300案件）

### システム構成
- **フロントエンド**: Cloud Run（512Mi, 1 CPU, max 10 instances）
- **バックエンド**: Cloud Run（512Mi, 1 CPU, max 10 instances）
- **データベース**: BigQuery（asia-northeast1）
- **ストレージ**: Artifact Registry（Dockerイメージ）
- **外部API**: 
  - Google Sheets API（無料）
  - **Google Maps Geocoding API（有料）**

### 想定利用パターン
- 1案件あたり1,000地点登録
- 1地点あたり1回のGeocoding API呼び出し（住所から緯度経度取得）
- 月間Geocoding API呼び出し: 300,000回
- 1案件あたり平均50回のAPIリクエスト（一覧取得、詳細取得、更新、地点登録等）
- 1日あたり平均10案件処理（300件/月 ÷ 30日）
- 1日あたり平均500リクエスト（10案件 × 50リクエスト）
- 月間APIリクエスト数: 約15,000リクエスト（500リクエスト/日 × 30日）

---

## 詳細コスト内訳

### 1. Cloud Run（フロントエンド + バックエンド）

#### 1.1 バックエンドAPI（universegeo-backend）

**設定**:
- メモリ: 512Mi
- CPU: 1 vCPU
- 最大インスタンス数: 10
- リージョン: asia-northeast1（東京）

**コスト計算**:
- **vCPU時間**: $0.00002400/vCPU-秒
- **メモリ**: $0.00000250/GiB-秒
- **リクエスト**: $0.40/100万リクエスト

**想定リクエスト数**: 月間15,000リクエスト
**想定平均実行時間**: 1リクエストあたり1.0秒（BigQueryクエリ、大量データ処理含む）

**計算**:
- vCPU時間: 15,000リクエスト × 1.0秒 × $0.00002400 = **$0.36**（約54円）
- メモリ: 15,000リクエスト × 1.0秒 × 0.5 GiB × $0.00000250 = **$0.01875**（約3円）
- リクエスト: 0.015百万リクエスト × $0.40 = **$0.006**（約1円）

**小計**: 約 **58円/月**

#### 1.2 フロントエンド（universegeo）

**設定**:
- メモリ: 512Mi
- CPU: 1 vCPU
- 最大インスタンス数: 10
- リージョン: asia-northeast1（東京）

**想定リクエスト数**: 月間30,000リクエスト（ページアクセス、静的ファイル配信）
**想定平均実行時間**: 1リクエストあたり0.2秒（静的ファイル配信）

**計算**:
- vCPU時間: 30,000リクエスト × 0.2秒 × $0.00002400 = **$0.144**（約22円）
- メモリ: 30,000リクエスト × 0.2秒 × 0.5 GiB × $0.00000250 = **$0.0075**（約1円）
- リクエスト: 0.03百万リクエスト × $0.40 = **$0.012**（約2円）

**小計**: 約 **25円/月**

#### 1.3 Cloud Run 合計（基本利用）

**合計**: 約 **83円/月**

**注意**: 上記は基本利用量での計算です。実際の利用では以下の要因で増加します：
- 同時アクセス数の増加
- リクエスト処理時間の増加（複雑なクエリ、大量データ処理）
- アイドル時間の発生（min-instances設定時）

#### 1.4 実運用想定（中規模利用）

**想定**:
- 月間リクエスト数: バックエンド50,000リクエスト、フロントエンド100,000リクエスト
- 平均実行時間: バックエンド1.5秒、フロントエンド0.3秒
- 同時実行: 平均3インスタンス

**計算**:
- **バックエンド**:
  - vCPU時間: 50,000 × 1.5秒 × $0.00002400 = $1.80（約270円）
  - メモリ: 50,000 × 1.5秒 × 0.5 GiB × $0.00000250 = $0.09375（約14円）
  - リクエスト: 0.05百万 × $0.40 = $0.02（約3円）
  - **小計**: 約 **287円/月**

- **フロントエンド**:
  - vCPU時間: 100,000 × 0.3秒 × $0.00002400 = $0.72（約108円）
  - メモリ: 100,000 × 0.3秒 × 0.5 GiB × $0.00000250 = $0.0375（約6円）
  - リクエスト: 0.1百万 × $0.40 = $0.04（約6円）
  - **小計**: 約 **120円/月**

**Cloud Run合計（中規模）**: 約 **407円/月**

#### 1.5 高負荷時想定

**想定**:
- 月間リクエスト数: バックエンド150,000リクエスト、フロントエンド300,000リクエスト
- 平均実行時間: バックエンド2.0秒、フロントエンド0.4秒
- 同時実行: 平均8インスタンス

**計算**:
- **バックエンド**: 約 **1,200円/月**
- **フロントエンド**: 約 **480円/月**

**Cloud Run合計（高負荷）**: 約 **1,680円/月**

---

### 2. Google Maps Geocoding API **最大コスト要因**

**単価**:
- 無料枠: 40,000リクエスト/月（$200クレジット）
- 40,001-100,000: $5.00/1,000リクエスト
- 100,001-500,000: $4.00/1,000リクエスト
- 500,001+: $3.50/1,000リクエスト

**想定利用量**: 月間300,000地点登録
- 各地点で住所から緯度経度を取得するため、Geocoding APIを1回呼び出し
- **月間API呼び出し数**: 300,000回

**計算**:
- 0-40,000: 無料
- 40,001-100,000: 60,000回 × $5.00/1,000 = **$300**（約45,000円）
- 100,001-300,000: 200,000回 × $4.00/1,000 = **$800**（約120,000円）

**合計**: **$1,100/月**（約 **165,000円/月**）

**注意**: 
- キャッシュ機能により、同じ住所の再ジオコーディングは回避されますが、新規地点が多い場合は上記のコストが発生します
- キャッシュヒット率が高い場合（例: 50%）、実際のコストは約82,500円/月まで削減可能

#### 2.1 コスト最適化のポイント

1. **キャッシュの活用**: 同じ住所の再ジオコーディングを避ける
2. **バッチ処理**: レート制限（50リクエスト/秒）を考慮した処理
3. **住所の正規化**: 重複を避ける
4. **無料枠の活用**: 月間40,000リクエストまでは無料

---

### 3. BigQuery

#### 3.1 ストレージコスト

**単価**: $0.020/GB-月（東京リージョン）

**データ量想定**:
- **プロジェクトテーブル**: 300件/月 × 平均2KB = 0.6MB/月
- **セグメントテーブル**: 300件/月 × 平均5KB = 1.5MB/月
- **POIテーブル**: 300,000地点/月 × 平均3KB = 900MB/月（約0.9GB/月）
- **ユーザーテーブル**: 50人 × 平均1KB = 0.05MB（初回のみ）
- **メッセージテーブル**: 300件/月 × 平均1KB = 0.3MB/月
- **その他テーブル**: 約10MB/月

**月間追加データ量**: 約 **912.45MB/月**（約0.91GB/月）

**計算**:
- 初月: 0.91GB × $0.020 = **$0.0182**（約2.7円）
- 6か月後: 5.46GB × $0.020 = **$0.1092**（約16円）
- 1年後: 10.92GB × $0.020 = **$0.2184**（約33円）

**ストレージコスト（1年後想定）**: 約 **33円/月**

**注意**: データ保持期間を長くする場合、ストレージコストは累積的に増加します。
- 2年保持: 約66円/月
- 3年保持: 約99円/月

#### 3.2 クエリ実行コスト（オンデマンド）

**単価**: $6.00/TB スキャン（最初の1TB/月は無料枠あり）

**クエリパターン想定**:
- **プロジェクト一覧取得**: 月間5,000回 × 平均10MBスキャン = 50GB/月
- **プロジェクト詳細取得**: 月間3,000回 × 平均5MBスキャン = 15GB/月
- **セグメント取得**: 月間5,000回 × 平均20MBスキャン = 100GB/月
- **POI取得**: 月間20,000回 × 平均50MBスキャン = 1,000GB/月（約1TB/月）
- **ユーザー取得**: 月間2,000回 × 平均5MBスキャン = 10GB/月
- **メッセージ取得**: 月間3,000回 × 平均10MBスキャン = 30GB/月
- **その他クエリ**: 約100GB/月

**月間スキャン量合計**: 約 **1,305GB/月**（約1.3TB/月）

**計算**:
- 1.3TB × $6.00 = **$7.80**（約1,170円/月）
- 無料枠適用後: (1.3TB - 1TB) × $6.00 = **$1.80**（約270円/月）

**注意**: POIテーブルが大きくなるため、クエリスキャン量が増加します。

#### 3.3 クエリ実行コスト（高負荷想定）

**想定**:
- より複雑なクエリ、JOIN処理、集計処理が増加
- 月間スキャン量: 2TB/月

**計算**:
- (2TB - 1TB) × $6.00 = **$6.00**（約900円/月）

#### 3.4 BigQuery合計

**中規模利用**: 約 **303円/月**（ストレージ33円 + クエリ270円）
**高負荷利用**: 約 **933円/月**（ストレージ33円 + クエリ900円）

---

### 3. Cloud Logging

**単価**:
- 取り込み: $0.50/GB（最初の50GB/月は無料）
- 保存: $0.01/GB-月（最初の50GB/月は無料）

**ログ量想定**:
- **バックエンドログ**: 6,000リクエスト/月 × 平均5KB = 30MB/月
- **フロントエンドログ**: 12,000リクエスト/月 × 平均2KB = 24MB/月
- **エラーログ**: 約10MB/月
- **その他ログ**: 約10MB/月

**月間ログ量**: 約 **74MB/月**（約0.074GB/月）

**計算**:
- 取り込み: 0.074GB × $0.50 = **$0.037**（約6円）
- 保存（30日保持）: 0.074GB × $0.01 = **$0.00074**（約0.1円）

**Cloud Logging合計**: 約 **6円/月**

**注意**: 無料枠（最初の50GB/月）があるため、実際のコストは **$0**（無料）です。

#### 3.1 実運用想定（ログ量増加）

**想定**:
- より詳細なログ出力、デバッグログの増加
- 月間ログ量: 5GB/月

**計算**:
- 取り込み: 5GB × $0.50 = **$2.50**（約375円/月）
- 保存（30日保持）: 5GB × $0.01 = **$0.05**（約8円/月）

**Cloud Logging合計（実運用）**: 約 **383円/月**

**注意**: 無料枠適用後: 5GB - 50GB（無料枠） = 0GB（無料）

---

### 4. Artifact Registry（Dockerイメージ保存）

**単価**:
- ストレージ: $0.10/GB-月
- ネットワーク転送: リージョン内は無料、外部は $0.12/GB

**イメージサイズ想定**:
- **バックエンドイメージ**: 約500MB（ビルド後）
- **フロントエンドイメージ**: 約300MB（ビルド後）
- **合計**: 約800MB（約0.8GB）

**計算**:
- ストレージ: 0.8GB × $0.10 = **$0.08**（約12円/月）

**Artifact Registry合計**: 約 **12円/月**

**注意**: イメージのバージョン管理により、複数のイメージが保存される場合があります。
- 5バージョン保持: 0.8GB × 5 × $0.10 = **$0.40**（約60円/月）

---

### 5. Google Sheets API

**料金**: 無料（クォータ内）

**クォータ**:
- 読み取り: 500リクエスト/100秒/ユーザー
- 書き込み: 100リクエスト/100秒/ユーザー

**想定利用**:
- 月間エクスポート: 300件/月（1案件あたり1回）
- リクエスト数: 300リクエスト/月

**コスト**: **$0**（無料）

---

### 6. ネットワーク転送コスト

**単価**:
- リージョン内転送: 無料
- インターネット向けegress: $0.12/GB（東京リージョン）

**転送量想定**:
- **フロントエンド配信**: 12,000リクエスト/月 × 平均500KB = 6GB/月
- **APIレスポンス**: 6,000リクエスト/月 × 平均100KB = 0.6GB/月
- **その他転送**: 約0.4GB/月

**月間転送量**: 約 **7GB/月**

**計算**:
- 7GB × $0.12 = **$0.84**（約126円/月）

**ネットワーク転送合計**: 約 **126円/月**

**注意**: リージョン内転送（Cloud Run ↔ BigQuery）は無料です。

---

### 7. Cloud Build（CI/CD）

**単価**:
- ビルド時間: $0.003/分（vCPU時間）
- ストレージ: $0.10/GB-月（ビルドアーティファクト）

**想定**:
- 月間デプロイ: 10回
- 1回あたりビルド時間: 5分
- ビルドアーティファクト: 約100MB

**計算**:
- ビルド時間: 10回 × 5分 × $0.003 = **$0.15**（約23円/月）
- ストレージ: 0.1GB × $0.10 = **$0.01**（約2円/月）

**Cloud Build合計**: 約 **25円/月**

**注意**: 無料枠（最初の120分/日）があるため、実際のコストは **$0**（無料）です。

---

## コスト試算まとめ

### 基本利用パターン（300,000地点/月）

| サービス | 月額コスト |
|---------|-----------|
| **Google Maps Geocoding API** | **約165,000円** |
| Cloud Run（フロントエンド + バックエンド） | 約83円 |
| BigQuery（ストレージ + クエリ） | 約303円 |
| Cloud Logging | 約200円（無料枠内） |
| Artifact Registry | 約60円（5バージョン保持） |
| Google Sheets API | 無料 |
| ネットワーク転送 | 約500円 |
| Cloud Build | 約25円（無料枠内） |
| **合計** | **約166,171円/月** |

### 中規模利用パターン（300,000地点/月 + 高アクセス）

| サービス | 月額コスト |
|---------|-----------|
| **Google Maps Geocoding API** | **約165,000円** |
| Cloud Run（フロントエンド + バックエンド） | 約407円 |
| BigQuery（ストレージ + クエリ） | 約303円 |
| Cloud Logging | 約500円（無料枠内） |
| Artifact Registry | 約60円（5バージョン保持） |
| Google Sheets API | 無料 |
| ネットワーク転送 | 約800円 |
| Cloud Build | 約25円（無料枠内） |
| **合計** | **約167,095円/月** |

### 高負荷利用パターン（300,000地点/月 + 超高アクセス）

| サービス | 月額コスト |
|---------|-----------|
| **Google Maps Geocoding API** | **約165,000円** |
| Cloud Run（フロントエンド + バックエンド） | 約1,680円 |
| BigQuery（ストレージ + クエリ） | 約933円 |
| Cloud Logging | 約1,000円（無料枠超過） |
| Artifact Registry | 約60円（5バージョン保持） |
| Google Sheets API | 無料 |
| ネットワーク転送 | 約1,500円 |
| Cloud Build | 約25円（無料枠内） |
| **合計** | **約170,198円/月** |

### キャッシュ最適化パターン（キャッシュヒット率50%）

| サービス | 月額コスト |
|---------|-----------|
| **Google Maps Geocoding API** | **約82,500円** ⚠️（キャッシュにより50%削減） |
| Cloud Run（フロントエンド + バックエンド） | 約407円 |
| BigQuery（ストレージ + クエリ） | 約303円 |
| Cloud Logging | 約500円 |
| Artifact Registry | 約60円 |
| Google Sheets API | 無料 |
| ネットワーク転送 | 約800円 |
| Cloud Build | 約25円 |
| **合計** | **約84,595円/月** |

### ⭐ 各人の無料枠活用パターン（推奨）

**10人以上がAPIキーを登録した場合**：

| サービス | 月額コスト |
|---------|-----------|
| **Google Maps Geocoding API** | **0円** ⭐（各人の無料枠で完全対応） |
| Cloud Run（フロントエンド + バックエンド） | 約407円 |
| BigQuery（ストレージ + クエリ） | 約303円 |
| Cloud Logging | 約500円 |
| Artifact Registry | 約60円 |
| Google Sheets API | 無料 |
| ネットワーク転送 | 約800円 |
| Cloud Build | 約25円 |
| **合計** | **約2,095円/月** ⭐ |

**コスト削減効果**: 約165,000円/月 → **約2,095円/月**（**約98.7%削減**）

---

## コスト最適化のポイント

### 1. Google Maps Geocoding API **最重要**

**最大のコスト要因**（月額165,000円）の削減が最優先：

#### 1.1 各人の無料枠を活用（推奨）⭐

**最も効果的な削減方法**：

- **各ユーザーが自分のGoogleアカウントでAPIキーを作成**
- **1人あたり40,000リクエスト/月が無料**
- **50人 × 40,000 = 2,000,000リクエスト/月（無料）**
- **月間300,000地点登録**: 完全に無料枠内で対応可能

**期待される効果**：
- **コスト削減**: 約165,000円/月 → **0円/月**
- **実装方法**: `MULTI_API_KEY_STRATEGY.md` を参照

**実装のポイント**：
1. ユーザー設定画面でAPIキーを登録できるようにする
2. ジオコーディング時にユーザーAPIキーをローテーション使用
3. 使用量を追跡し、無料枠超過のAPIキーは自動的に無効化
4. 月次リセット機能で毎月1日に使用量をリセット

**必要な登録人数**：
- **10人以上**: 月間300,000地点登録を無料枠内で対応可能
- **30人以上**: より余裕を持って運用可能

#### 1.2 キャッシュの徹底活用

1. **キャッシュの徹底活用**
   - 同じ住所の再ジオコーディングを完全に回避
   - キャッシュヒット率50%で約82,500円削減可能
   - データベース（BigQuery）にキャッシュを保存し、永続化

2. **住所の正規化**
   - 住所の表記揺れを統一（「東京都」vs「東京」など）
   - 重複登録の防止

3. **バッチ処理の最適化**
   - レート制限（50リクエスト/秒）を考慮した処理
   - エラー時のリトライ処理

4. **代替手段の検討**
   - 都道府県・市区町村レベルの座標を使用（精度が許容範囲内の場合）
   - 外部のジオコーディングサービスとの比較検討

### 2. Cloud Run
- **min-instances = 0** を維持（アイドル時の固定費を回避）
- リクエスト処理時間の最適化（キャッシュの活用）
- 不要なログ出力の削減

### 3. BigQuery
- クエリの最適化（必要な列のみ選択、パーティションの活用）
- データ保持期間の見直し（古いデータのアーカイブ）
- 無料枠（1TB/月）の活用
- POIテーブルのパーティション化（日付やプロジェクトIDで分割）

### 4. Cloud Logging
- ログレベルの適切な設定（INFO以上のみ保存）
- ログ保持期間の短縮（30日 → 7日）
- 無料枠（50GB/月）の活用

### 5. ネットワーク転送
- CDNの活用（Cloud CDN）で転送コスト削減
- 静的ファイルの最適化（圧縮、キャッシュ）

---

## 注意事項

1. **為替レート**: 本試算は1USD = 150円で計算しています。実際の為替レートにより変動します。

2. **無料枠**: GCPには無料枠がありますが、本試算では最小利用パターンで無料枠内、中規模利用パターンで一部無料枠内、高負荷利用パターンで無料枠超過を想定しています。

3. **実際のコスト**: 実際のコストは利用パターン、データ量、リクエスト数により大きく変動します。定期的にコストを監視し、最適化を行うことを推奨します。

4. **追加コスト**: 本試算には含まれていませんが、以下のコストが発生する可能性があります：
   - Cloud SQL（リレーショナルデータベースを使用する場合）
   - Cloud Storage（ファイル保存が必要な場合）
   - Cloud Load Balancing（外部ロードバランサーを使用する場合）
   - その他のGCPサービス

5. **Google Maps Geocoding API**: 本試算の最大コスト要因です。キャッシュの徹底活用により、最大50%のコスト削減が可能です。

---

## 📅 更新履歴

- 2025-01-XX: 初版作成（コードベース分析に基づく試算）
- 2025-01-XX: Vertex AIエージェント機能のコスト試算を追加（`VERTEX_AI_AGENT_IMPLEMENTATION.md`参照）

---

## 🤖 Vertex AIエージェント機能の追加コスト

Vertex AIエージェント機能を実装した場合の追加コスト試算：

### 利用パターン別コスト

| 利用パターン | 月間クエリ数 | Vertex AIコスト | 合計コスト（既存+Vertex AI） |
|------------|------------|----------------|---------------------------|
| 軽度利用 | 1,000クエリ | 約1,800円 | 約3,895円/月 |
| 中程度利用 | 2,500クエリ | 約4,875円 | 約6,970円/月 |
| 高度利用 | 5,000クエリ | 約10,200円 | 約12,295円/月 |
| 最大利用 | 10,000クエリ | 約20,700円 | 約22,795円/月 |

**詳細**: `VERTEX_AI_AGENT_IMPLEMENTATION.md` を参照

### 期待される効果

- **作業時間の短縮**: 月間1,000時間の削減効果（間接的）
- **データ品質の向上**: 入力ミスの削減、バリデーションの自動化
- **ユーザー体験の向上**: 自然言語での操作、マニュアル不要

### 推奨実装方針

1. **段階的な導入**: 軽度利用から開始し、効果を確認しながら拡張
2. **コスト管理**: 使用量の監視、予算アラートの設定
3. **ROI評価**: コストと効果のバランスを考慮

