# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
FROM node:20-alpine AS builder

WORKDIR /app

# ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache python3 make g++ libc6-compat

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤ºï¼‰
COPY package*.json ./
RUN echo "ğŸ“¦ Installing dependencies..." && \
    npm ci 2>&1 || (echo "âš ï¸ npm ci failed, trying npm install..." && npm install 2>&1) || \
    (echo "âŒ npm install failed!" && exit 1)

# TypeScriptè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY tsconfig.json ./

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY src ./src

# ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
RUN echo "ğŸ“‹ Verifying files..." && \
    ls -la && \
    ls -la src/ && \
    [ -f tsconfig.json ] && echo "âœ… tsconfig.json exists" || (echo "âŒ tsconfig.json not found!" && exit 1) && \
    [ -f src/index.ts ] && echo "âœ… src/index.ts exists" || (echo "âŒ src/index.ts not found!" && exit 1)

# TypeScriptã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤ºï¼‰
RUN echo "ğŸ”¨ Building TypeScript..." && \
    npm run build 2>&1 || (echo "âŒ TypeScript build failed!" && exit 1) && \
    echo "âœ… Build completed successfully" && \
    ls -la dist/

# æœ¬ç•ªã‚¹ãƒ†ãƒ¼ã‚¸
FROM node:20-alpine

WORKDIR /app

# æœ¬ç•ªä¾å­˜é–¢ä¿‚ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm ci --omit=dev || npm install --production

# ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/dist ./dist

# ãƒãƒ¼ãƒˆã‚’å…¬é–‹
EXPOSE 8080

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
CMD ["node", "dist/index.js"]

