name: Setup Cloud Scheduler

on:
  workflow_dispatch:

env:
  REGION: asia-northeast1
  BACKEND_SERVICE: universegeo-backend
  JOB_NAME: universegeo-sheet-export

jobs:
  setup-scheduler:
    name: Create / Update Cloud Scheduler Job
    runs-on: ubuntu-latest

    environment:
      name: Environment secrets

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Backend URL
        id: backend
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Create or Update Scheduler Job
        run: |
          BACKEND_URL="${{ steps.backend.outputs.url }}"
          SCHEDULER_SECRET="${{ secrets.SCHEDULER_SECRET }}"

          # 既存ジョブがあれば update、なければ create
          if gcloud scheduler jobs describe ${{ env.JOB_NAME }} \
              --location=${{ env.REGION }} \
              --project=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }} \
              > /dev/null 2>&1; then
            gcloud scheduler jobs update http ${{ env.JOB_NAME }} \
              --location=${{ env.REGION }} \
              --project=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }} \
              --schedule="30 12 * * 1,3,5" \
              --time-zone="UTC" \
              --uri="${BACKEND_URL}/api/sheets/run-scheduled-export" \
              --http-method=POST \
              --headers="Content-Type=application/json,X-Scheduler-Token=${SCHEDULER_SECRET}" \
              --message-body="{}" \
              --attempt-deadline=600s
            echo "✅ Scheduler job updated"
          else
            gcloud scheduler jobs create http ${{ env.JOB_NAME }} \
              --location=${{ env.REGION }} \
              --project=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }} \
              --schedule="30 12 * * 1,3,5" \
              --time-zone="UTC" \
              --uri="${BACKEND_URL}/api/sheets/run-scheduled-export" \
              --http-method=POST \
              --headers="Content-Type=application/json,X-Scheduler-Token=${SCHEDULER_SECRET}" \
              --message-body="{}" \
              --attempt-deadline=600s
            echo "✅ Scheduler job created"
          fi

      - name: Summary
        run: |
          echo "## ✅ Cloud Scheduler Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ env.JOB_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Schedule**: 月・水・金 21:30 JST (12:30 UTC)" >> $GITHUB_STEP_SUMMARY
          echo "- **Endpoint**: ${{ steps.backend.outputs.url }}/api/sheets/run-scheduled-export" >> $GITHUB_STEP_SUMMARY
