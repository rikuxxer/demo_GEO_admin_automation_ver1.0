# Excel一括登録バリデーションチェックリスト

## 実装済みのバリデーション

### 1. 配信先（media_id）

#### ✅ 実装済み
- [x] 空の場合のエラー表示
- [x] 複数選択対応（カンマ区切り: `UNIVERSE、TVer(SP)`）
- [x] TVer(CTV)の排他制御（他の配信先と併用不可）
- [x] 無効な配信先名のエラー表示
- [x] 空配列の場合は空文字列に変換

#### テストケース
```
✅ "UNIVERSE" → ["universe"]
✅ "UNIVERSE、TVer(SP)" → ["universe", "tver_sp"]
✅ "UNIVERSE,TVer(SP)" → ["universe", "tver_sp"]（半角カンマ）
❌ "TVer(CTV)、UNIVERSE" → エラー（排他制御）
❌ "" → エラー（必須項目）
❌ "無効な配信先" → エラー（無効な値）
```

### 2. 配信範囲（designated_radius）

#### ✅ 実装済み
- [x] 空の場合のエラー表示
- [x] "50m" 形式のバリデーション（正規表現: `^\d+m$`）
- [x] 文字列として保存（"50m"、"100m" など）
- [x] 全33種類の選択肢に対応

#### テストケース
```
✅ "50m" → "50m"
✅ "10000m" → "10000m"
❌ "50" → エラー（単位なし）
❌ "" → エラー（必須項目）
❌ "50km" → エラー（無効な単位）
```

### 3. 配信期間（extraction_period）

#### ✅ 実装済み
- [x] 空の場合のエラー表示
- [x] プリセット値のマッピング
- [x] 居住者・勤務者の場合は「直近3ヶ月」固定
- [x] 居住者・勤務者で他の期間を指定した場合のエラー＆自動補正

#### テストケース
```
✅ "直近1ヶ月" → "1month"
✅ "直近6ヶ月" → "6month"
✅ 居住者 + "直近1ヶ月" → "3month"（自動補正＋エラー表示）
✅ 居住者 + "直近3ヶ月" → "3month"（正常）
❌ "" → エラー（必須項目）
❌ "無効な期間" → エラー（無効な値）
```

### 4. 対象者（attribute）

#### ✅ 実装済み
- [x] 空の場合のエラー表示
- [x] 「検知者」「居住者」「勤務者」のマッピング
- [x] 居住者・勤務者選択時の抽出期間自動補正（UI/パーサー両方）

#### テストケース
```
✅ "検知者" → "detector"
✅ "居住者" → "resident"（extraction_periodが自動的に3month）
✅ "勤務者" → "worker"（extraction_periodが自動的に3month）
❌ "" → エラー（必須項目）
❌ "無効な対象者" → エラー（無効な値）
```

### 5. 検知回数（detection_count）

#### ✅ 実装済み
- [x] 空の場合のエラー表示
- [x] "1回以上"〜"5回以上"のマッピング
- [x] 数値型への変換

#### テストケース
```
✅ "1回以上" → 1
✅ "5回以上" → 5
❌ "" → エラー（必須項目）
❌ "10回以上" → エラー（無効な値）
```

### 6. 滞在時間（stay_time）

#### ✅ 実装済み
- [x] オプション項目（空OK）
- [x] "5分以上"〜"3時間以上"のマッピング
- [x] 後方互換性（"5分"も受付）

#### テストケース
```
✅ "" → 空（オプション）
✅ "5分以上" → "5min"
✅ "3時間以上" → "3hour"
✅ "30分" → "30min"（後方互換性）
❌ "無効な時間" → エラー（無効な値）
```

### 7. セグメント名の重複チェック

#### ✅ 実装済み
- [x] 同一ファイル内でのセグメント名重複をエラー表示

#### テストケース
```
❌ セグメント1: "東京エリア"、セグメント2: "東京エリア" → エラー（重複）
✅ セグメント1: "東京エリア"、セグメント2: "大阪エリア" → OK
```

### 8. UI上の自動補正

#### ✅ 実装済み（BulkImportEditor.tsx）
- [x] 対象者を「居住者」「勤務者」に変更すると抽出期間が自動的に「直近3ヶ月」になる
- [x] 配信範囲セレクトボックスが無効化される
- [x] TVer(CTV)選択時、他の配信先チェックボックスが無効化される
- [x] 無限ループ防止（useMemo + needsUpdateフラグ）

## エッジケース対応

### 1. 空配列/空文字列
- [x] media_idが空配列の場合 → 空文字列に変換
- [x] 空文字列のmedia_idはフィルタで除外

### 2. 文字化け防止
- [x] ExcelファイルはXLSXライブラリでバイナリ生成
- [x] UTF-8エンコーディングを保持

### 3. 型の整合性
- [x] ExcelSegmentData.media_id: string | string[]
- [x] Segment.media_id: string | string[]
- [x] 型が一致

### 4. useEffectの安全性
- [x] useMemoで依存配列を最適化
- [x] needsUpdateフラグで無限ループを防止
- [x] 変更が必要な場合のみ更新

## 今後の拡張ポイント

### 1. ファイルサイズ制限
- [ ] 大容量ファイル（10MB以上）の警告
- [ ] 地点数上限（1000件以上）の警告

### 2. より詳細なエラーメッセージ
- [ ] セルの座標（A1形式）をエラーメッセージに追加
- [ ] 修正例の提示

### 3. 段階的な修正支援
- [ ] エラー箇所へのジャンプ機能
- [ ] 一括修正の提案

### 4. バックエンド連携時のバリデーション
- [ ] 重複チェック（既存データとの照合）
- [ ] 権限チェック
- [ ] 配信期間の妥当性チェック（過去日付など）
