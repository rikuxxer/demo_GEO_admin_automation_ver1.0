# 案件閲覧権限 - テストシナリオ

## テストデータ準備

### ユーザー
- **管理者**: 管理太郎（role: admin）
- **営業A**: 営業A（role: sales）
- **営業B**: 営業B（role: sales）

### 案件データ

| 案件ID | 主担当 | 副担当 | ステータス |
|--------|--------|--------|-----------|
| PRJ-0001 | 営業A | - | 下書き（draft） |
| PRJ-0002 | 営業A | 営業B | 進行中（in_progress） |
| PRJ-0003 | 営業A | - | 連携完了（linked） |
| PRJ-0004 | 営業B | - | 下書き（draft） |
| PRJ-0005 | 営業B | - | 進行中（in_progress） |
| PRJ-0006 | 営業B | 営業A | 連携完了（linked） |

## テストシナリオ

### シナリオ 1: 管理者でログイン
**期待結果**: すべての案件（6件）が表示される

**確認項目**:
- [ ] 案件一覧に6件の案件が表示される
- [ ] すべての案件の詳細を開くことができる
- [ ] サマリーカードに6件と表示される

---

### シナリオ 2: 営業Aでログイン（自分の案件のみフィルタOFF）
**期待結果**: 
- 自分が担当の案件: PRJ-0001, PRJ-0002, PRJ-0003, PRJ-0006（4件）
- 他人の連携完了案件: なし（営業Bの連携完了案件は既にPRJ-0006で副担当として含まれている）
- 合計: 4件

**確認項目**:
- [ ] 案件一覧に4件の案件が表示される
  - [ ] PRJ-0001（主担当）
  - [ ] PRJ-0002（主担当）
  - [ ] PRJ-0003（主担当）
  - [ ] PRJ-0006（副担当）
- [ ] PRJ-0004（営業Bの下書き）は表示されない
- [ ] PRJ-0005（営業Bの進行中）は表示されない
- [ ] すべての表示されている案件の詳細を開くことができる
- [ ] サマリーカードに4件と表示される

---

### シナリオ 3: 営業Aでログイン（自分の案件のみフィルタON）
**期待結果**: 自分が主担当または副担当の案件のみ（4件）

**確認項目**:
- [ ] 「自分の案件のみ」ボタンが青色でアクティブ状態
- [ ] 案件一覧に4件の案件が表示される
  - [ ] PRJ-0001（主担当）
  - [ ] PRJ-0002（主担当）
  - [ ] PRJ-0003（主担当）
  - [ ] PRJ-0006（副担当）
- [ ] サマリーカードに4件と表示される

**注**: このケースでは閲覧権限と「自分の案件のみ」フィルタの結果が同じになる

---

### シナリオ 4: 営業Bでログイン（自分の案件のみフィルタOFF）
**期待結果**: 
- 自分が担当の案件: PRJ-0002, PRJ-0004, PRJ-0005, PRJ-0006（4件）
- 他人の連携完了案件: PRJ-0003（営業Aの連携完了）
- 合計: 5件

**確認項目**:
- [ ] 案件一覧に5件の案件が表示される
  - [ ] PRJ-0002（副担当）
  - [ ] PRJ-0003（他人の連携完了案件）★
  - [ ] PRJ-0004（主担当）
  - [ ] PRJ-0005（主担当）
  - [ ] PRJ-0006（主担当）
- [ ] PRJ-0001（営業Aの下書き）は表示されない
- [ ] すべての表示されている案件の詳細を開くことができる
- [ ] サマリーカードに5件と表示される

---

### シナリオ 5: 営業Bでログイン（自分の案件のみフィルタON）
**期待結果**: 自分が主担当または副担当の案件のみ（4件）

**確認項目**:
- [ ] 「自分の案件のみ」ボタンが青色でアクティブ状態
- [ ] 案件一覧に4件の案件が表示される
  - [ ] PRJ-0002（副担当）
  - [ ] PRJ-0004（主担当）
  - [ ] PRJ-0005（主担当）
  - [ ] PRJ-0006（主担当）
- [ ] PRJ-0003（営業Aの連携完了案件）は表示されない
- [ ] サマリーカードに4件と表示される

---

### シナリオ 6: 営業AがURLで営業Bの進行中案件にアクセス
**操作**: 営業Aでログイン後、PRJ-0005（営業Bの進行中案件）をクリックまたは直接URL入力

**期待結果**: アクセス拒否

**確認項目**:
- [ ] エラートースト「この案件を閲覧する権限がありません」が表示される
- [ ] 案件詳細画面は開かない
- [ ] 案件一覧画面に留まる

---

### シナリオ 7: 営業AがURLで営業Bの連携完了案件にアクセス
**操作**: 営業Aでログイン後、PRJ-0006をクリック

**期待結果**: 正常にアクセスできる（副担当として）

**確認項目**:
- [ ] 案件詳細画面が正常に表示される
- [ ] 案件情報が正しく表示される
- [ ] セグメント一覧が表示される
- [ ] 地点情報が表示される

---

### シナリオ 8: 営業Bが他人の連携完了案件（PRJ-0003）にアクセス
**操作**: 営業Bでログイン後、PRJ-0003（営業Aの連携完了案件）をクリック

**期待結果**: 正常にアクセスできる（連携完了案件なので閲覧可）

**確認項目**:
- [ ] 案件詳細画面が正常に表示される
- [ ] 案件情報が正しく表示される
- [ ] セグメント一覧が表示される
- [ ] 地点情報が表示される
- [ ] 編集ボタンは表示されない（編集権限はない）

---

### シナリオ 9: ステータス別サマリーカードの確認（営業A）
**期待結果**: 営業Aの担当案件のみが集計される

**確認項目**:
- [ ] 総案件数: 4件
- [ ] 下書き: 1件（PRJ-0001）
- [ ] 進行中: 1件（PRJ-0002）
- [ ] 連携完了: 2件（PRJ-0003, PRJ-0006）

---

### シナリオ 10: ステータス別サマリーカードの確認（営業B、自分の案件のみOFF）
**期待結果**: 営業Bの担当案件 + 他人の連携完了案件が集計される

**確認項目**:
- [ ] 総案件数: 5件
- [ ] 下書き: 1件（PRJ-0004）
- [ ] 進行中: 2件（PRJ-0002, PRJ-0005）
- [ ] 連携完了: 2件（PRJ-0003, PRJ-0006）

---

### シナリオ 11: 検索機能との連動（営業A）
**操作**: 営業Aでログイン後、「営業B」で検索

**期待結果**: 
- 営業Bが主担当で営業Aが副担当の案件のみ表示される

**確認項目**:
- [ ] PRJ-0002（営業A主担当、営業B副担当）が表示される
- [ ] PRJ-0006（営業B主担当、営業A副担当）が表示される
- [ ] その他の案件は表示されない

---

### シナリオ 12: 案件ステータス変更時の動的な権限更新
**操作**: 
1. 管理者でログイン
2. PRJ-0005（営業Bの進行中案件）のステータスを「連携完了」に変更
3. 営業Aでログイン

**期待結果**: PRJ-0005が営業Aの案件一覧に表示される

**確認項目**:
- [ ] 営業Aの案件一覧にPRJ-0005が表示される
- [ ] 営業AがPRJ-0005の詳細を開くことができる
- [ ] 営業AはPRJ-0005を編集できない（編集ボタンが表示されない）

---

## エッジケース

### ケース 1: 副担当が未設定の案件
**確認項目**:
- [ ] 副担当が undefined でもエラーが発生しない
- [ ] 主担当のみで権限判定が正しく行われる

### ケース 2: ユーザー情報が null の場合
**確認項目**:
- [ ] ログイン画面にリダイレクトされる
- [ ] エラーが発生しない

### ケース 3: セグメントが未登録の案件（下書き状態）
**確認項目**:
- [ ] 下書き案件も閲覧権限のロジックが正しく適用される
- [ ] 主担当/副担当は下書き案件も閲覧可能

## 実装チェックリスト

### ユーティリティ関数
- [x] `canViewProject` 関数が `/utils/editRequest.ts` に実装されている
- [x] 関数のJSDocコメントが記載されている
- [x] ビジネスルールが正しく実装されている

### コンポーネント
- [x] `ProjectTable.tsx` でフィルタリングが実装されている
- [x] `App.tsx` の `handleProjectClick` で権限チェックが実装されている
- [x] `SummaryCards.tsx` でフィルタリングが実装されている
- [x] 各コンポーネントに適切なコメントが記載されている

### エクスポート
- [x] `canViewProject` が `/utils/editRequest.ts` からエクスポートされている
- [x] 各コンポーネントで正しくインポートされている

### ドキュメント
- [x] 仕様書（VIEW_PERMISSION_SPEC.md）が作成されている
- [x] テストシナリオ（このファイル）が作成されている

## 注意事項

### パフォーマンス
- 案件一覧のフィルタリングで毎回 `getAutoProjectStatus` を呼び出しているため、案件数が多い場合はパフォーマンスに注意
- 必要に応じて、ステータスをキャッシュする実装を検討

### セキュリティ
- フロントエンドでの権限チェックのため、バックエンドAPIでも同様のチェックが必要
- BigQuery APIのアクセス権限も適切に設定する必要がある

### UX
- 閲覧できない案件は一覧に表示されないため、ユーザーは存在を認識できない
- 必要に応じて「他のチームの案件が〇件進行中です」といった情報表示も検討
