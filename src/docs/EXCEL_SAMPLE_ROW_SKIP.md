# Excelサンプル行の自動スキップ機能

## 概要

Excelテンプレートに含まれるサンプル行を、ユーザーが削除せずにそのままアップロードできるように、パーサー側で自動的にスキップする機能です。

## 背景

### 課題
従来、Excelテンプレートには記入例としてサンプルデータが含まれていましたが、ユーザーはアップロード前にこれらを手動で削除する必要がありました。

**問題点:**
1. サンプル行の削除を忘れると、サンプルデータが登録されてしまう
2. どの行がサンプルか分かりにくい
3. 手間がかかり、ユーザビリティが低下

### 解決策
サンプル行を自動的に識別してスキップする機能を実装しました。

## 実装仕様

### サンプル行の識別条件

以下のいずれかに該当する行は、サンプル行として自動的にスキップされます：

```typescript
function isSampleRow(row: any[]): boolean {
  if (!row || row.length === 0) return false;
  
  const firstCell = String(row[0] || '').trim().toLowerCase();
  
  // サンプル行の判定条件：
  // 1. "サンプル" という文字を含む
  // 2. "sample" という文字を含む
  // 3. "(例)" という文字を含む
  // 4. 空行
  if (!firstCell) return true;
  if (firstCell.includes('サンプル') || 
      firstCell.includes('sample') || 
      firstCell.includes('(例)') ||
      firstCell.includes('（例）') ||
      firstCell === 'xxx' ||
      firstCell === '---') {
    return true;
  }
  
  return false;
}
```

### 対象シート

以下の3つのシートでサンプル行のスキップが有効です：

1. **②案件情報シート**
2. **③セグメント設定シート**
3. **④地点リストシート**

### テンプレートでのサンプル行の表現

#### ②案件情報シート
```excel
広告主名                      | 代理店名              | 訴求内容           | ...
サンプル株式会社（自動スキップ） | サンプル広告代理店     | 新商品キャンペーン  | ...
```

#### ③セグメント設定シート
```excel
セグメント名                  | 配信先            | 配信範囲 | ...
サンプル：東京エリア（自動スキップ）| UNIVERSE,TVer(SP) | 500m    | ...
サンプル：大阪エリア（自動スキップ）| TVer(CTV)         | 300m    | ...
```

#### ④地点リストシート
```excel
どのセグメント？                    | 地点の名前 | 住所                   | ...
サンプル：東京エリア（自動スキップ） | 東京タワー | 東京都港区芝公園4-2-8  | ...
```

### スタイル設定

サンプル行は視覚的に識別しやすくするため、以下のスタイルが適用されています：

```typescript
const sampleStyle = {
  fill: {
    type: 'pattern' as const,
    pattern: 'solid' as const,
    fgColor: { argb: 'FFA0A0A0' } // 濃いグレー背景（#A0A0A0）
  },
  font: {
    italic: true,
    color: { argb: 'FF303030' }, // 濃いグレー文字
    name: 'Meiryo'
  }
};
```

- **背景色**: 濃いグレー (#A0A0A0)
- **フォント**: イタリック、濃いグレー (#303030)

## パース処理の流れ

### 1. 案件情報シートのパース

```typescript
// ヘッダー行の次から、サンプル行をスキップして最初の有効な行を取得
let inputRow: any[] | null = null;
let inputRowIndex = -1;

for (let i = 1; i < data.length; i++) {
  const row = data[i];
  if (!isSampleRow(row)) {
    inputRow = row;
    inputRowIndex = i;
    console.log(`案件情報入力行（${i + 1}行目）:`, inputRow);
    break;
  } else {
    console.log(`サンプル行をスキップ（${i + 1}行目）:`, row);
  }
}

if (!inputRow) {
  errors.push({
    section: '②案件情報',
    message: '有効な案件情報が入力されていません（サンプル行のみ）'
  });
  return null;
}
```

### 2. セグメント設定シートのパース

```typescript
// 2行目以降（サンプル行と入力行）を処理
for (let i = 1; i < data.length; i++) {
  const row = data[i];
  const rowNum = i + 1;

  // サンプル行をスキップ
  if (isSampleRow(row)) {
    console.log(`セグメント行${rowNum}をスキップ（サンプル行）:`, row);
    continue;
  }

  // 空行をスキップ
  const segmentName = row[0];
  if (!segmentName || String(segmentName).trim() === '' || 
      String(segmentName).trim() === '(ここに入力)') {
    console.log(`セグメント行${rowNum}をスキップ（空行）: ${segmentName}`);
    continue;
  }

  // 有効な行を処理
  console.log(`セグメント行${rowNum}を処理: ${segmentName}`);
  // ... セグメントデータの処理
}
```

### 3. 地点リストシートのパース

```typescript
for (let i = 1; i < data.length; i++) {
  const row = data[i];
  const rowNum = i + 1;

  // サンプル行をスキップ
  if (isSampleRow(row)) {
    console.log(`地点リスト行${rowNum}をスキップ（サンプル行）:`, row);
    continue;
  }

  // 空行をスキップ
  const segmentNameRef = row[0];
  if (!segmentNameRef || String(segmentNameRef).trim() === '' || 
      String(segmentNameRef).trim() === '(ここに入力)') {
    console.log(`地点リスト行${rowNum}をスキップ（空行）: ${segmentNameRef}`);
    continue;
  }

  // 有効な行を処理
  console.log(`地点リスト行${rowNum}を処理: ${segmentNameRef}`);
  // ... 地点データの処理
}
```

## ログ出力

開発モードでは、スキップされた行がコンソールに出力されます：

```
案件情報シート全データ: [...]
案件情報シート行数: 3
サンプル行をスキップ（2行目）: ["サンプル株式会社", "サンプル広告代理店", ...]
案件情報入力行（3行目）: ["株式会社テスト", "テスト代理店", ...]

セグメント行2をスキップ（サンプル行）: ["サンプル：東京エリア", "UNIVERSE,TVer(SP)", ...]
セグメント行3をスキップ（サンプル行）: ["サンプル：大阪エリア", "TVer(CTV)", ...]
セグメント行4を処理: 新宿エリア

地点リスト行2をスキップ（サンプル行）: ["サンプル：東京エリア", "東京タワー", ...]
地点リスト行3を処理: 新宿エリア
```

## エラーケース

### ケース1: サンプル行のみで有効なデータがない

```typescript
if (!inputRow) {
  errors.push({
    section: '②案件情報',
    message: '有効な案件情報が入力されていません（サンプル行のみ）'
  });
  return null;
}
```

**エラーメッセージ:**
```
②案件情報: 有効な案件情報が入力されていません（サンプル行のみ）
```

### ケース2: セグメントがすべてサンプル行

セグメント設定シートにサンプル行しかない場合：

```
③セグメント設定: セグメント設定が入力されていません
```

## ユーザーへの案内

### 入力ガイドでの説明

①入力ガイドシートに以下の説明を記載：

```
⚠️ 注意事項
・✨ サンプル行は削除不要！自動的にスキップされます
```

```
STEP 1: 「②案件情報」シートを開く
　└─ サンプル行はそのままでOK（自動的にスキップされます）

STEP 2: 「③セグメント設定」シートを開く
　└─ サンプル行はそのままでOK（自動的にスキップされます）

STEP 3: 「④地点リスト」シートを開く
　└─ サンプル行はそのままでOK（自動的にスキップされます）
```

## テストケース

### テストケース1: サンプル行のみ

**入力:**
```excel
広告主名
サンプル株式会社
```

**期待結果:**
```
エラー: 有効な案件情報が入力されていません（サンプル行のみ）
```

### テストケース2: サンプル行 + 有効なデータ

**入力:**
```excel
広告主名                | 代理店名
サンプル株式会社         | サンプル代理店
株式会社テスト          | テスト代理店
```

**期待結果:**
```
案件情報:
  広告主名: 株式会社テスト
  代理店名: テスト代理店
```

### テストケース3: 複数のサンプル行

**入力:**
```excel
セグメント名
サンプル：東京エリア
サンプル：大阪エリア
(例)名古屋エリア
新宿エリア
渋谷エリア
```

**期待結果:**
```
セグメント: 2件登録
  - 新宿エリア
  - 渋谷エリア
```

## メリット

1. **ユーザビリティ向上**
   - サンプル行の削除が不要
   - テンプレートをダウンロードしてすぐに使える

2. **エラー防止**
   - サンプルデータが誤って登録されることを防ぐ
   - 削除忘れによるミスを防止

3. **作業効率化**
   - 手動削除の手間を削減
   - 記入例を見ながら入力できる

4. **社外連携の簡素化**
   - 広告主や代理店への説明が簡単
   - 「サンプルはそのままでOK」と一言で済む

## 今後の改善案

1. **サンプル行の追加パターン**
   - 「見本」「参考」などの文言にも対応
   - 正規表現によるより柔軟な判定

2. **複数サンプルセットの提供**
   - 業種別のサンプルデータ
   - ユースケース別のテンプレート

3. **視覚的な強化**
   - サンプル行に「削除不要」の注釈を追加
   - ツールチップで説明を表示

## 関連ファイル

- `/utils/excelParser.ts` - パース処理の実装
- `/utils/excelTemplateGenerator.ts` - テンプレート生成
- `/docs/EXCEL_BULK_IMPORT_SPEC.md` - Excel一括登録の仕様書
- `/BULK_IMPORT_README.md` - ユーザー向けガイド
