# 案件ステータス自動判定ルール仕様書

**バージョン:** 1.0  
**最終更新日:** 2024年12月  
**作成者:** 開発チーム  
**関連実装:** `/utils/projectStatus.ts`

---

## 📋 目次

1. [概要](#概要)
2. [ステータス定義](#ステータス定義)
3. [判定ルール](#判定ルール)
4. [判定フローチャート](#判定フローチャート)
5. [判定に使用するデータ項目](#判定に使用するデータ項目)
6. [詳細仕様](#詳細仕様)
7. [境界条件とエッジケース](#境界条件とエッジケース)
8. [UI表示仕様](#ui表示仕様)

---

## 概要

### 目的
案件のステータスを、配下のセグメント・地点・連携状況から自動的に判定し、営業担当者と管理部門が案件の進捗状況を一目で把握できるようにする。

### 基本方針
- **自動判定**: ユーザーが手動でステータスを変更する必要はない
- **リアルタイム更新**: セグメントや地点の登録・変更時に即座に再計算
- **透明性**: 判定理由を常に表示し、なぜそのステータスなのかを明確にする

---

## ステータス定義

案件ステータスは以下の3種類に自動判定される：

| ステータス | 内部値 | 表示名 | 意味 |
|-----------|--------|--------|------|
| 下書き | `draft` | 下書き | 案件は登録されているが、まだセグメントが未登録の状態 |
| 進行中 | `in_progress` | 進行中 | セグメントが登録され、地点登録や連携作業が進行中の状態 |
| 連携完了 | `linked` | 連携完了 | 管理部によるデータ連携が完了し、配信準備が整った状態 |

---

## 判定ルール

### ルール優先順位

ステータスは以下の優先順位で判定される（上から順にチェック）：

```
1. 連携完了の判定
   ↓ (該当しない場合)
2. 進行中の判定
   ↓ (該当しない場合)
3. 下書きの判定
```

---

### 【ステータス1】下書き（draft）

#### 判定条件
```
セグメント数 = 0
```

#### 詳細
- 案件は登録されているが、配下のセグメントが1件も登録されていない状態
- 営業担当者がまだ案件の詳細設定を行っていない段階

#### 表示される理由メッセージ
```
「配下のセグメントが未登録」
```

#### 次のアクション
- セグメントを登録する
- または、案件自体を削除する

---

### 【ステータス2】進行中（in_progress）

#### 判定条件
```
セグメント数 ≧ 1
かつ
全セグメントのdata_link_status ≠ 'linked'
```

#### 詳細
- セグメントが1件以上登録されている
- まだデータ連携が完了していないセグメントが存在する
- 地点やアカウントIDの登録状況は問わない（詳細は理由メッセージで表示）

#### 表示される理由メッセージのバリエーション

##### パターン1: すべての条件を満たしている
```
「セグメント・地点・アカウントID登録済み」
```

**条件**:
- すべてのセグメントに最低1つの地点が登録されている
- すべてのセグメントにAdsアカウントIDが記載されている

##### パターン2: 地点が未登録のセグメントがある
```
「準備中: 2件のセグメントに地点未登録」
```

**条件**:
- 一部のセグメントに地点が1件も登録されていない

##### パターン3: アカウントIDが未記載のセグメントがある
```
「準備中: 1件のセグメントにアカウントID未記載」
```

**条件**:
- 一部のセグメントのAdsアカウントIDが空文字またはnull

##### パターン4: 両方の条件が未達
```
「準備中: 2件のセグメントに地点未登録, 1件のセグメントにアカウントID未記載」
```

**条件**:
- 地点未登録とアカウントID未記載の両方が存在する

##### パターン5: セグメントのみ登録
```
「セグメント登録済み」
```

**条件**:
- セグメントは登録されているが、地点もアカウントIDもまだ設定されていない
- 理由メッセージの配列が空の場合のフォールバック

#### 次のアクション
- 地点が未登録の場合 → 地点を登録する
- アカウントIDが未記載の場合 → アカウントIDを入力する
- すべて完了している場合 → 管理部にデータ連携を依頼する

---

### 【ステータス3】連携完了（linked）

#### 判定条件
```
セグメント数 ≧ 1
かつ
すべてのセグメントのdata_link_status = 'linked'
```

#### 詳細
- すべてのセグメントでデータ連携が完了している
- 配信準備が整った状態

#### 表示される理由メッセージ
```
「管理部のデータ連携が完了」
```

#### 次のアクション
- 配信開始を待つ
- または、配信実績を確認する

---

## 判定フローチャート

```
[案件が存在]
    │
    ├─ セグメント数 = 0 ？
    │   └─ YES → 【下書き】
    │            理由: 「配下のセグメントが未登録」
    │
    ├─ NO（セグメント数 ≧ 1）
    │   │
    │   ├─ すべてのセグメントのdata_link_status = 'linked' ？
    │   │   └─ YES → 【連携完了】
    │   │            理由: 「管理部のデータ連携が完了」
    │   │
    │   └─ NO
    │       └─ → 【進行中】
    │            │
    │            ├─ すべてのセグメントに地点が存在 ？
    │            │   └─ NO → 理由に追加: 「X件のセグメントに地点未登録」
    │            │
    │            ├─ すべてのセグメントにアカウントIDが存在 ？
    │            │   └─ NO → 理由に追加: 「X件のセグメントにアカウントID未記載」
    │            │
    │            └─ 両方OK → 理由: 「セグメント・地点・アカウントID登録済み」
```

---

## 判定に使用するデータ項目

### プロジェクト（Project）テーブル
| 項目 | 用途 |
|------|------|
| `project_id` | セグメントとの紐付けに使用 |

### セグメント（Segment）テーブル
| 項目 | 用途 |
|------|------|
| `project_id` | 案件に紐づくセグメントをフィルタ |
| `segment_id` | 地点との紐付けに使用 |
| `ads_account_id` | アカウントID記載状況の判定 |
| `data_link_status` | 連携完了判定に使用 |

### 地点情報（PoiInfo）テーブル
| 項目 | 用途 |
|------|------|
| `segment_id` | セグメントに紐づく地点をフィルタ |

### 判定に使用しない項目
以下の項目は判定には使用しない：
- `poi_request_status`（地点格納依頼ステータス）
- `project_status`（手動設定されたステータス）※将来的に廃止予定
- 配信期間（`delivery_start_date`, `delivery_end_date`）

---

## 詳細仕様

### 1. セグメント数のカウント方法

```typescript
const projectSegments = allSegments.filter(
  seg => seg.project_id === project.project_id
);
const segmentCount = projectSegments.length;
```

- 論理削除されたセグメントは含まない（削除フラグがある場合）
- すべてのセグメントをカウント（ステータスは問わない）

---

### 2. 地点の存在チェック

```typescript
const allSegmentsHavePois = projectSegments.every(seg =>
  projectPois.some(poi => poi.segment_id === seg.segment_id)
);
```

#### ロジック
- **すべて**のセグメントに**最低1つ**の地点が必要
- 1つでも地点が0件のセグメントがあれば `false`

#### 地点未登録のセグメント数の計算
```typescript
const segmentsWithoutPois = projectSegments.filter(seg =>
  !projectPois.some(poi => poi.segment_id === seg.segment_id)
);
const count = segmentsWithoutPois.length;
```

---

### 3. アカウントIDの存在チェック

```typescript
const hasAllAccountIds = 
  projectSegments.length > 0 && 
  projectSegments.every(seg => 
    seg.ads_account_id && 
    seg.ads_account_id.trim() !== ''
  );
```

#### ロジック
- `null`、`undefined`、空文字、空白文字のみは「未記載」と判定
- すべてのセグメントにAdsアカウントIDが必要

#### アカウントID未記載のセグメント数の計算
```typescript
const segmentsWithoutAccountId = projectSegments.filter(seg =>
  !seg.ads_account_id || seg.ads_account_id.trim() === ''
);
const count = segmentsWithoutAccountId.length;
```

---

### 4. データ連携完了の判定

```typescript
const linkedSegmentCount = projectSegments.filter(
  seg => seg.data_link_status === 'linked'
).length;

const isAllLinked = 
  segmentCount > 0 && 
  linkedSegmentCount === segmentCount;
```

#### ロジック
- **すべて**のセグメントが `data_link_status = 'linked'` である必要がある
- 1つでも `'not_linked'` や `'pending'` があれば連携完了ではない

---

## 境界条件とエッジケース

### ケース1: セグメント0件の案件
```
判定: 下書き
理由: 「配下のセグメントが未登録」
```

### ケース2: セグメント1件、地点0件、アカウントIDなし
```
判定: 進行中
理由: 「準備中: 1件のセグメントに地点未登録, 1件のセグメントにアカウントID未記載」
```

### ケース3: セグメント3件、すべて地点あり、2件アカウントIDなし
```
判定: 進行中
理由: 「準備中: 2件のセグメントにアカウントID未記載」
```

### ケース4: セグメント2件、1件は連携完了、1件は未完了
```
判定: 進行中
理由: 「セグメント・地点・アカウントID登録済み」
（すべて登録されているが、まだ連携が完了していない）
```

### ケース5: セグメント5件、すべて連携完了
```
判定: 連携完了
理由: 「管理部のデータ連携が完了」
```

### ケース6: セグメントが論理削除された場合
```
判定: 下書き
理由: 「配下のセグメントが未登録」
（アクティブなセグメントが0件になるため）
```

### ケース7: アカウントIDが空白文字のみ（"   "）
```
判定: 準備中
理由: 「X件のセグメントにアカウントID未記載」
（trim()後に空文字になるため）
```

---

## UI表示仕様

### SummaryCards（ダッシュボード）

各ステータスのカード表示：

| ステータス | アイコン | 背景色 | アイコン色 | 説明文 |
|-----------|---------|--------|-----------|-------|
| 下書き | `FileEdit` | `bg-indigo-50` | `text-indigo-600` | セグメント未登録の案件 |
| 進行中 | `Loader2` | `bg-blue-50` | `text-blue-600` | セグメント登録済みの案件 |
| 連携完了 | `CheckCircle2` | `bg-sky-50` | `text-sky-600` | データ連携が完了した案件 |

#### ツールチップ表示

各カードの右上にInfoアイコンを表示し、ホバー時に詳細ルールを表示：

**下書き**:
```
【下書き】
・配下のセグメントが未登録（0件）
```

**進行中**:
```
【進行中】
・配下のセグメントが存在している（1件以上）
※地点やアカウントIDの登録状況は各案件の詳細で確認できます
```

**連携完了**:
```
【連携完了】
・管理部のデータ連携が完了している
```

---

### ProjectTable（案件一覧）

ステータスバッジの表示：

| ステータス | バッジスタイル | アイコン |
|-----------|--------------|---------|
| 下書き | `bg-indigo-50 text-indigo-600 border-indigo-200` | `FileEdit` |
| 進行中 | `bg-blue-50 text-blue-600 border-blue-200` | `Loader2` |
| 連携完了 | `bg-sky-50 text-sky-600 border-sky-200` | `CheckCircle2` |

#### ツールチップ（title属性）

バッジにマウスホバーすると、判定理由が表示される：

- 下書き: 「配下のセグメントが未登録」
- 進行中: 「セグメント・地点・アカウントID登録済み」
- 進行中: 「準備中: 2件のセグメントに地点未登録」
- 連携完了: 「管理部のデータ連携が完了」

---

## 実装参考

### 関数シグネチャ

```typescript
// ステータス判定
export function getAutoProjectStatus(
  project: Project,
  allSegments: Segment[],
  allPois: PoiInfo[]
): ProjectStatusInfo;

// ステータス別カウント
export function countProjectsByStatus(
  projects: Project[],
  allSegments: Segment[],
  allPois: PoiInfo[]
): {
  draft: number;
  in_progress: number;
  linked: number;
  total: number;
};

// 色の取得
export function getStatusColor(status: AutoProjectStatus): {
  bg: string;
  text: string;
  badge: string;
};
```

### 返り値の型

```typescript
export interface ProjectStatusInfo {
  status: AutoProjectStatus;        // 'draft' | 'in_progress' | 'linked'
  label: string;                     // '下書き' | '進行中' | '連携完了'
  reason: string;                    // 判定理由（ツールチップで表示）
  segmentCount: number;              // セグメント数
  poiCount: number;                  // 地点数
  hasAllAccountIds: boolean;         // 全セグメントにアカウントIDがあるか
  linkedSegmentCount: number;        // 連携完了済みセグメント数
}
```

---

## 今後の拡張

### 検討中の機能
1. **期限切れステータス**: 配信期間終了後に自動的に「期限切れ」ステータスに変更
2. **警告表示**: 配信開始まで1週間を切っているのに進行中の場合、警告を表示
3. **履歴管理**: ステータス変更の履歴を保存し、いつ進行中になったかを追跡

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2024-12-XX | 1.0 | 初版作成 |

---

**END OF DOCUMENT**
