# UNIVERSEGEO システム仕様書

**バージョン:** 1.0  
**最終更新日:** 2024年12月  
**作成者:** 開発チーム

---

## 📋 目次

1. [システム概要](#システム概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [主要機能](#主要機能)
4. [データモデル](#データモデル)
5. [ユーザーロールと権限](#ユーザーロールと権限)
6. [業務フロー](#業務フロー)
7. [画面構成](#画面構成)
8. [技術スタック](#技術スタック)
9. [セキュリティ](#セキュリティ)
10. [制約事項とビジネスルール](#制約事項とビジネスルール)

---

## システム概要

### プロダクト名
**UNIVERSEGEO（ユニバースジオ）**

### 目的
位置情報を活用した広告配信案件を管理するSaaSプロダクト。営業担当者と管理部門が協力して、広告主の案件登録から配信設定、データ連携までを一元管理する。

### 主要ユーザー
- **営業担当者**: 案件の登録、セグメント設定、地点登録、連携依頼
- **管理部門**: ステータス管理、データ連携対応、全体監視

### コアバリュー
1. **案件管理の効率化**: 案件・セグメント・地点を体系的に管理
2. **CSV/Excel一括登録**: 大量データの効率的な入力
3. **ロールベースアクセス制御**: 役割に応じた適切な権限管理
4. **地点管理の柔軟性**: 3つの登録方法（任意地点、都道府県市区町村、PKG）
5. **データ連携の可視化**: ステータス管理による進捗の透明化

---

## システムアーキテクチャ

### 全体構成

```
┌─────────────────────────────────────────────────────┐
│                   Frontend (React)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │
│  │ 案件管理画面  │  │ 管理者画面   │  │ 認証画面   │  │
│  └──────────────┘  └──────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────┘
                          ↓ ↑
┌─────────────────────────────────────────────────────┐
│                   API Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │
│  │ BigQuery API │  │ Geocoding API│  │ Auth API  │  │
│  └──────────────┘  └──────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────┘
                          ↓ ↑
┌─────────────────────────────────────────────────────┐
│                Database (BigQuery)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │
│  │ Projects DB  │  │ Segments DB  │  │  POI DB   │  │
│  └──────────────┘  └──────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────┘
```

### レイヤー構成

#### 1. プレゼンテーション層
- React + TypeScript
- Tailwind CSS によるスタイリング
- ShadcnUI コンポーネントライブラリ

#### 2. ビジネスロジック層
- Context API による状態管理（AuthContext）
- カスタムフック
- バリデーションロジック

#### 3. データアクセス層
- BigQuery Service（`/utils/bigquery.ts`）
- Geocoding Service（`/utils/geocoding.ts`）
- CSV/Excelパーサー（`/utils/completeBulkParser.ts`, `/utils/csvParser.ts`）

#### 4. データ永続化層
- Google BigQuery（本番環境想定）
- ローカルストレージ（モックデータ）

---

## 主要機能

### 1. 認証・権限管理
- **ログイン機能**: メールアドレスとパスワードによる認証
- **ロールベース制御**: 管理者（admin）と営業（sales）の2つのロール
- **権限による機能制限**: 各ロールに応じた画面・操作の制御

### 2. 案件管理

#### 案件登録
- **手動登録**: フォームによる1件ずつの登録
- **一括登録**: CSV/Excel による案件・セグメント・地点の同時登録

#### 案件情報項目
- 広告主法人名（必須）
- 代理店名（任意）
- 訴求内容（必須）
- UNIVERSEサービスID/名（任意）
- 配信開始日・終了日（必須）
- 主担当者・副担当者
- 備考
- 案件ステータス

#### 案件ステータス（自動判定）

**自動判定される3つのステータス**:
- **下書き**（draft）: 配下のセグメントが未登録
- **進行中**（in_progress）: セグメントが登録済み（地点・アカウントID登録状況は詳細に表示）
- **連携完了**（linked）: 全セグメントのデータ連携が完了

**詳細**: [案件ステータス自動判定ルール仕様書](./PROJECT_STATUS_RULES.md) 参照

**判定に使用するデータ**:
- セグメント数（0件 = 下書き、1件以上 = 進行中）
- 各セグメントのdata_link_status（全件'linked' = 連携完了）
- 地点の登録状況（詳細情報として表示）
- AdsアカウントIDの記載状況（詳細情報として表示）

### 3. セグメント管理

#### セグメント登録
- 案件に紐づく配信セグメントの設定
- 複数セグメントの登録可能
- セグメント共通条件の一括設定

#### セグメント情報項目
- セグメント名（任意）
- 配信媒体（UNIVERSE / TVer(SP) / TVer(CTV)）
- 地点依頼ステータス（未依頼 / 格納対応中 / 格納完了）
- データ連携ステータス（連携依頼前 / 連携依頼済 / 連携済）
- AdsアカウントID
- プロバイダセグメントID（管理部入力）
- セグメント共通条件（後述）

#### セグメント共通条件
1つのセグメントに属する全地点に適用される条件：
- **指定半径**: 50m〜10000m
- **抽出期間**: プリセット（1〜6ヶ月）または期間指定
- **属性**: 検知者 / 居住者 / 勤務者
- **検知回数**: 〇回以上（1〜5回以上）
- **検知時間帯**: 開始時刻〜終了時刻
- **滞在時間**: 5分〜3時間

### 4. 地点管理

#### 地点登録方法（3種類）
1. **任意地点指定**: 個別に地点名と住所または緯度経度を入力
2. **都道府県・市区町村指定**: プルダウンから選択
3. **PKG指定**: カテゴリ（コンビニ、駅など）から選択

#### 地点登録フロー
**2ステップ登録**:
1. **STEP 1**: 地点登録方法の選択
2. **STEP 2**: 詳細情報の入力

#### 地点CSV一括登録
- セグメント共通条件を1行目に記載
- 2行目以降に地点情報を記載
- 住所または緯度経度の自動判定

#### Geocoding API連携
- 住所から緯度経度を自動取得
- Google Maps Geocoding API 使用（想定）

### 5. CSV/Excel一括登録

案件・セグメント・地点を1つのファイルで一括登録できる機能。CSV形式とExcel形式の2種類をサポート。

#### CSV形式（従来形式）
```
[PROJECT]
広告主法人名,代理店名,訴求内容,...

[SEGMENT]
セグメント名,配信媒体,指定半径,...

[LOCATION:セグメント名]
地点名,住所,緯度,経度
```

**特徴**:
- セクションマーカー（`[PROJECT]`など）でデータを区分
- テキストエディタでも編集可能
- 技術者向け

#### Excel形式（新機能・推奨）
5シート構成のExcelファイル（.xlsx）で、社外の方でも入力可能な設計。

##### シート構成
| シート | 名称 | 内容 |
|--------|------|------|
| ① | 入力ガイド | 使い方の説明、FAQ |
| ② | 案件情報 | 広告主名、訴求内容、配信期間など |
| ③ | セグメント設定 | 配信条件（複数行可） |
| ④ | 地点リスト | 配信地点（複数行可） |
| ⑤ | 選択肢リスト | プルダウン用データ（非表示） |

##### 主要機能
1. **プルダウン入力**: 配信先、配信範囲、対象者などを選択式に
   - 配信先: UNIVERSE / TVer(スマホ) / TVer(テレビ)
   - 配信範囲: 50m / 100m / 300m / 500m / 1000m / 3000m / 5000m / 10000m
   - 対象者: 検知された人 / 居住者 / 勤務者
   
2. **色分け表示**: 
   - 黄色背景 = 必須項目
   - 青色背景 = プルダウン選択項目
   
3. **サンプルデータ**: 各シートに記入例を含む

4. **動的参照**: 地点リストのセグメント選択は、セグメント設定シートの内容を自動参照

5. **入力規則**: 日付形式、緯度経度の範囲などを事前チェック

##### わかりやすい用語
技術用語を排除し、非技術者でも理解できる日本語表記を採用：

| 内部用語 | 表示用語 |
|---------|---------|
| media_id | 配信先 |
| designated_radius | 配信範囲 |
| extraction_period | 配信期間 |
| attribute | 対象者 |
| detection_count | 検知回数 |

##### バリデーション
- **入力時**: Excelの入力規則によるチェック
- **アップロード時**: システムによる詳細チェック
  - 必須項目チェック
  - データ型チェック
  - ビジネスルールチェック（TVer(CTV)排他制御など）
  - 参照整合性チェック（セグメント名の紐付けなど）

##### エラー表示
詳細なエラーメッセージを表示：
```
セグメント設定シート 3行目:
配信先「TVer(テレビ)」は他の配信先と併用できません。
2行目で「UNIVERSE」が選択されています。
どちらか一方のみを選択してください。
```

#### 比較表

| 項目 | CSV形式 | Excel形式 |
|------|---------|-----------|
| 対象ユーザー | 技術者 | 非技術者も可 |
| 入力方法 | テキスト手入力 | プルダウン選択 |
| エラー検知 | アップロード時のみ | 入力時+アップロード時 |
| ガイド | 外部ドキュメント | ファイル内に含む |
| サンプル | なし | 各シートに含む |
| 社外連携 | 難しい | 容易 |

**詳細**: [Excel一括登録機能仕様書](./EXCEL_BULK_IMPORT_SPEC.md) 参照

### 6. ステータス管理

#### 地点依頼ステータス（営業が管理）
- **未依頼**: 地点登録作業中
- **格納対応中**: 管理部に依頼済み
- **格納完了**: 管理部の作業完了

#### データ連携ステータス（管理部が管理）
- **連携依頼前**: AdsアカウントID記載済み
- **連携依頼済**: 連携対応中
- **連携済**: 連携完了

### 7. 管理者機能

#### ダッシュボード
- 全案件のステータス集計
- 営業別パフォーマンス表示
- データ診断機能

#### ステータス一括管理
- 案件ステータスの一括変更
- セグメントステータスの一括変更

#### 営業別パフォーマンス
- 担当案件数
- セグメント数
- 地点数
- ステータス内訳

### 8. 検索・フィルタリング

#### 案件テーブルフィルタ
- フリーワード検索
- 担当者フィルタ
- ステータスフィルタ
- 期間フィルタ

#### 営業ユーザー用デフォルトフィルタ
- 「自分の案件のみ」フィルターが初期状態でON

### 9. 編集制限機能

#### 地点格納依頼後の制限
- 地点データの修正を不可に
- AdsアカウントIDと連携依頼のみ編集可能
- 誤操作防止のための仕様

### 10. 修正依頼・承認フロー

**詳細**: [修正依頼・承認フロー仕様書](./EDIT_REQUEST_APPROVAL_SPEC.md) 参照

#### 概要
一度登録された案件・セグメント・地点情報を修正する際に、営業が修正依頼を作成し、管理部が承認することで変更を反映させる機能。

#### 適用範囲
- **案件**: 配下のセグメントが1件以上存在する場合
- **セグメント**: 地点格納依頼後（`location_request_status = 'storing'` 以降）
- **地点**: 地点格納依頼後（セグメントの`location_request_status = 'storing'` 以降）

#### 基本フロー
1. **営業**: 修正依頼を作成（変更内容と理由を記載）
2. **管理部**: 依頼を確認し、承認または却下
3. **承認時**: 自動的に変更内容が反映
4. **却下時**: 却下理由を記載し、営業に通知

#### 権限
- **営業**: 修正依頼の作成、自分の依頼の確認、承認待ち依頼の取り下げ
- **管理部**: すべての依頼の確認・承認・却下、直接編集も可能

---

## データモデル

詳細は `DATABASE_SCHEMA.md` と `ER_DIAGRAM.md` を参照。

### エンティティ概要

#### Project（案件）
- 広告主の案件情報を管理
- 1案件に複数のセグメントが紐づく

#### Segment（セグメント）
- 配信設定の単位
- 1セグメントに複数の地点が紐づく
- セグメント共通条件を持つ

#### PoiInfo（地点情報）
- 配信対象地点の詳細情報
- セグメント共通条件を継承

#### User（ユーザー）
- システム利用者情報
- ロール（admin / sales）を持つ

### リレーション

```
Project (1) ─── (N) Segment (1) ─── (N) PoiInfo
   │                                      
   └── person_in_charge ─── User
```

---

## ユーザーロールと権限

詳細は `ROLE_PERMISSIONS.md` を参照。

### ロール定義

#### 管理者（admin）
- すべての機能へのアクセス権限
- ステータス管理権限
- 全案件の閲覧・編集権限

#### 営業（sales）
- 案件・セグメント・地点の登録・編集
- 自分の案件の管理
- ステータス管理不可

---

## 業務フロー

詳細は `BUSINESS_FLOW.md` を参照。

### 基本的な案件登録フロー

```
1. 営業: 案件登録
   ↓
2. 営業: セグメント登録
   ↓
3. 営業: 地点登録（手動 or CSV/Excel一括）
   ↓
4. 営業: 地点格納依頼（ステータス変更）
   ↓
5. 管理部: 地点格納作業
   ↓
6. 管理部: 格納完了（ステータス変更）
   ↓
7. 営業: AdsアカウントID入力
   ↓
8. 営業: データ連携依頼
   ↓
9. 管理部: データ連携作業
   ↓
10. 管理部: 連携完了（ステータス変更）
```

---

## 画面構成

詳細は `SCREEN_TRANSITION.md` を参照。

### 主要画面

1. **ログイン画面**
2. **案件一覧画面**（メイン画面）
3. **案件詳細画面**（3タブ構成）
   - 案件概要タブ
   - セグメント管理タブ
   - 地点情報タブ
4. **管理者ダッシュボード**
5. **案件ステータス管理画面**
6. **セグメントステータス管理画面**

---

## 技術スタック

### フロントエンド
- **フレームワーク**: React 18 + TypeScript
- **スタイリング**: Tailwind CSS v4.0
- **UIライブラリ**: ShadcnUI
- **状態管理**: Context API
- **ルーティング**: クライアントサイドルーティング
- **アイコン**: lucide-react

### バックエンド（想定）
- **データベース**: Google BigQuery
- **API**: REST API（想定）
- **認証**: JWT（想定）

### 外部API
- **Geocoding**: Google Maps Geocoding API（想定）

### 開発ツール
- **パッケージマネージャー**: npm / yarn
- **ビルドツール**: Vite（想定）
- **バージョン管理**: Git

---

## セキュリティ

### 認証
- メールアドレス + パスワード認証
- セッション管理（Context API）

### 認可
- ロールベースアクセス制御（RBAC）
- 画面レベルでの権限チェック
- 機能レベルでの権限チェック

### データ保護
- 個人情報の適切な管理
- BigQueryのパーティショニングによるデータ分離

### 入力検証
- フロントエンドでのバリデーション
- CSV/Excel解析時のエラーチェック
- 必須項目チェック
- データ型チェック
- ビジネスルールチェック

---

## 制約事項とビジネスルール

### 配信媒体の排他制御
- **TVer(CTV)** は他の配信媒体と同一案件内で併用不可
- 1つの案件でTVer(CTV)を選択した場合、他のセグメントではUNIVERSEまたはTVer(SP)のみ選択可能

### セグメント共通条件の統一ルール
- 1つのセグメントに属する全地点は、同じ条件（半径、期間、属性など）を共有
- 地点ごとに異なる条件を設定したい場合は、別のセグメントを作成

### 属性による抽出期間の制約
- **居住者** または **勤務者** を選択した場合、抽出期間は自動的に **3ヶ月** に固定
- **検知者** の場合は、1〜6ヶ月または期間指定が可能

### 地点格納依頼後の編集制限
- 地点格納依頼（ステータス: 格納対応中）以降は、地点情報の編集が不可
- 編集可能な項目:
  - AdsアカウントID
  - データ連携依頼
  - プロバイダセグメントID（管理部のみ）

### セグメント有効期限
- データ連携完了から **6ヶ月後** が自動的に有効期限日として設定される

### 日付の妥当性チェック
- 配信終了日 >= 配信開始日
- 抽出終了日 >= 抽出開始日

### CSV/Excel一括登録時のルール
- **案件情報**: 1件のみ登録可能
- **セグメント情報**: 複数件登録可能
- **地点情報**: 各セグメントに紐づく形で登録
- セグメント名は重複不可

### 担当者フィルタ
- 営業ユーザーの場合、初期状態で「自分の案件のみ」フィルターがON
- 管理者ユーザーの場合、初期状態ですべての案件を表示

### 案件ステータス自動判定ルール

**詳細**: [案件ステータス自動判定ルール仕様書](./PROJECT_STATUS_RULES.md) 参照

#### 判定優先順位
1. セグメント数 = 0 → **下書き**
2. 全セグメントのdata_link_status = 'linked' → **連携完了**  
3. 上記以外 → **進行中**（地点やアカウントIDの状況は詳細メッセージで表示）

#### 判定に使用しない項目
- `poi_request_status`（地点格納依頼ステータス）
- `project_status`（手動設定ステータス）※将来的に廃止予定
- 配信期間（開始日・終了日）

#### 理由メッセージのバリエーション
- 下書き: 「配下のセグメントが未登録」
- 進行中: 「セグメント・地点・アカウントID登録済み」
- 進行中: 「準備中: 2件のセグメントに地点未登録, 1件のセグメントにアカウントID未記載」
- 連携完了: 「管理部のデータ連携が完了」

---

## 今後の拡張予定

### 機能拡張
1. **通知機能**: ステータス変更時のメール通知
2. **履歴管理**: 案件・セグメント・地点の変更履歴
3. **レポート機能**: 配信実績レポートの自動生成
4. **API連携**: 外部システムとのデータ連携
5. **モバイル対応**: レスポンシブデザインの強化

### データ拡張
1. **配信実績データ**: インプレッション数、クリック数など
2. **効果測定データ**: コンバージョン、ROI計算
3. **ユーザー行動データ**: 操作ログ、アクセス解析

---

## 参考ドキュメント

### コアドキュメント
- [データベーススキーマ定義](./DATABASE_SCHEMA.md)
- [ER図](./ER_DIAGRAM.md)
- [テーブル定義書（CSV）](./TABLE_DEFINITIONS.csv)
- [案件ステータス自動判定ルール仕様書](./PROJECT_STATUS_RULES.md) ⭐新規
- [修正依頼・承認フロー仕様書](./EDIT_REQUEST_APPROVAL_SPEC.md) ⭐新規
- [権限設計書](./ROLE_PERMISSIONS.md)
- [画面遷移図](./SCREEN_TRANSITION.md)
- [業務フロー図](./BUSINESS_FLOW.md)

### 一括登録関連
- [Excel一括登録機能仕様書](./EXCEL_BULK_IMPORT_SPEC.md) ⭐新規
- [Excelテンプレート定義（CSV）](./EXCEL_TEMPLATE_DEFINITION.csv) ⭐新規
- [一括登録フロー図](./BULK_IMPORT_FLOW.md) ⭐新規
- [CSV一括登録ガイド（従来形式）](../BULK_IMPORT_README.md)

### バックエンド関連
- [BigQueryスキーマ定義](../backend-example/bigquery-schema.md)

---

**END OF DOCUMENT**
