name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGION: asia-northeast1
  SERVICE_NAME: universegeo-backend

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    
    # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨çµ±ä¸€ã™ã‚‹ãŸã‚ã€Environment secrets ã‚’ä½¿ç”¨
    environment:
      name: Environment secrets
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required secrets
        run: |
          echo "ðŸ” å¿…é ˆSecretsã®ç¢ºèªä¸­..."
          echo "  Environment: Environment secrets"
          echo "  âš ï¸ æ³¨æ„: environmentãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€Secretsã¯ç’°å¢ƒã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã™"
          echo ""
          
          # ç’°å¢ƒã‚¹ã‚³ãƒ¼ãƒ—ã®Secretsã‚’ç¢ºèªï¼ˆenvironmentãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ç’°å¢ƒã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰å–å¾—ã•ã‚Œã‚‹ï¼‰
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ GCP_SA_KEY is missing"
            echo "   ç’°å¢ƒã‚¹ã‚³ãƒ¼ãƒ—ã®Secretsã« GCP_SA_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
            echo "   Settings > Environments > Environment secrets > Secrets"
            echo ""
            echo "ðŸ“ è¨­å®šæ‰‹é †:"
            echo "1. https://github.com/${{ github.repository }}/settings/environments/Environment%20secrets ã‚’é–‹ã"
            echo "2. Secrets ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ŒAdd secretã€ã‚’ã‚¯ãƒªãƒƒã‚¯"
            echo "3. Name: GCP_SA_KEYï¼ˆå¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’æ­£ç¢ºã«ï¼‰"
            echo "4. Secret: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ï¼ˆJSONï¼‰ã®å†…å®¹å…¨ä½“ã‚’è²¼ã‚Šä»˜ã‘"
            echo "5. ã€ŒAdd secretã€ã‚’ã‚¯ãƒªãƒƒã‚¯"
            echo ""
            echo "è©³ç´°ã¯ GCP_SA_KEY_SETUP.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          if [ -z "${{ secrets.BQ_DATASET }}" ]; then
            echo "âŒ BQ_DATASET is missing"
            echo "   ç’°å¢ƒã‚¹ã‚³ãƒ¼ãƒ—ã®Secretsã« BQ_DATASET ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] && [ -z "${{ vars.GCP_PROJECT_ID }}" ]; then
            echo "âŒ GCP_PROJECT_ID is missing"
            echo "   ç’°å¢ƒã‚¹ã‚³ãƒ¼ãƒ—ã®Secretsã¾ãŸã¯Varsã« GCP_PROJECT_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          echo "âœ… å¿…é ˆSecretsãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          echo ""
          echo "ðŸ“‹ ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª:"
          echo "  GCP_SA_KEY: âœ… SET"
          echo "  GCP_PROJECT_ID: $([ -n "${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}" ] && echo 'âœ… SET' || echo 'âŒ NOT SET')"
          echo "  BQ_DATASET: âœ… SET"
          echo "  GOOGLE_SPREADSHEET_ID: $([ -n "${{ secrets.GOOGLE_SPREADSHEET_ID }}" ] && echo 'âœ… SET' || echo 'âš ï¸ NOT SET')"
          echo "  FRONTEND_URL: $([ -n "${{ secrets.FRONTEND_URL }}" ] && echo 'âœ… SET' || echo 'âš ï¸ NOT SET')"
          echo "  BACKEND_SERVICE_ACCOUNT: $([ -n "${{ secrets.BACKEND_SERVICE_ACCOUNT }}" ] && echo 'âœ… SET' || echo 'âš ï¸ NOT SET (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSAãŒä½¿ç”¨ã•ã‚Œã¾ã™)')"
          echo "  SCHEDULER_SECRET: $([ -n "${{ secrets.SCHEDULER_SECRET }}" ] && echo 'âœ… SET' || echo 'âŒ NOT SET')"

          if [ -z "${{ secrets.SCHEDULER_SECRET }}" ]; then
            echo "âŒ SCHEDULER_SECRET is missing"
            echo "   Settings > Environments > Environment secrets > Secrets ã« SCHEDULER_SECRET ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify Backend Files
        working-directory: ./backend
        run: |
          echo "ðŸ” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:"
          echo ""
          echo "ðŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
          ls -la
          echo ""
          echo "ðŸ“„ é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:"
          echo "  Dockerfile: $([ -f Dockerfile ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"
          echo "  package.json: $([ -f package.json ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"
          echo "  tsconfig.json: $([ -f tsconfig.json ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"
          echo "  src/index.ts: $([ -f src/index.ts ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ env.SERVICE_NAME }}
          source: ./backend
          region: ${{ env.REGION }}
          project_id: ${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
          
          # é‡è¦: æ—¢å­˜ã® env ã‚’å£Šã•ãšè¿½åŠ æ›´æ–°
          env_vars_update_strategy: merge
          env_vars: |-
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
            BQ_DATASET=${{ secrets.BQ_DATASET }}
            GOOGLE_SPREADSHEET_ID=${{ secrets.GOOGLE_SPREADSHEET_ID }}
            GOOGLE_SHEETS_API_KEY=${{ secrets.GOOGLE_SHEETS_API_KEY }}
            GOOGLE_SHEET_NAME=${{ secrets.GOOGLE_SHEET_NAME }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
            SCHEDULER_SECRET=${{ secrets.SCHEDULER_SECRET }}

          flags: >-
            --allow-unauthenticated
            --memory 512Mi
            --cpu 1
            --max-instances 10
            --timeout=600
          
          # æ‰‹å‹•ã® update-traffic ã‚’æ¶ˆã™
          revision_traffic: 'LATEST=100'

      - name: Deployment Summary
        run: |
          echo "## âœ… Backend Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Environment secrets" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å…±æœ‰ï¼ˆç·¨é›†è€…æ¨©é™ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "ðŸš€ Backend deployed to: ${{ steps.deploy.outputs.url }}"
