# 案件ID採番規則

## 概要

案件IDは、システム内で案件を一意に識別するための識別子です。自動採番により、重複なく連番で割り当てられます。

## 採番形式

### 基本形式

**形式**: `PRJ-{連番}`

**例**:
- `PRJ-1` - 1件目の案件
- `PRJ-2` - 2件目の案件
- `PRJ-10` - 10件目の案件
- `PRJ-100` - 100件目の案件

### 形式の詳細

- **プレフィックス**: `PRJ-`（固定）
- **連番**: 1から始まる連続する整数
- **桁数**: 可変（1桁、2桁、3桁など、必要に応じて増加）

## 採番ロジック

### 1. 既存案件の最大番号を取得

システムは、データベース内の既存の案件IDから、以下の条件を満たすIDを検索します：

- `PRJ-` で始まる
- その後に数字のみが続く（正規表現: `^PRJ-\d+$`）
- 例: `PRJ-1`, `PRJ-2`, `PRJ-123` など

### 2. 次の番号を計算

- 最大番号に +1 した値を次の案件IDとして使用
- 案件が存在しない場合（初回登録時）は `PRJ-1` から開始

### 3. エラー時のフォールバック

データベースアクセスエラーが発生した場合、タイムスタンプベースのIDを使用します：

**フォールバック形式**: `PRJ-{タイムスタンプ}`

**例**: `PRJ-1705123456789`

## 実装詳細

### バックエンド実装

**ファイル**: `backend/src/bigquery-client.ts`

**関数**: `generateNextProjectId()`

```typescript
async generateNextProjectId(): Promise<string> {
  // 1. 既存の案件IDから最大の番号を取得（BigQueryクエリ）
  // 2. 最大番号 + 1 を計算
  // 3. PRJ-{番号} 形式で返す
  // 4. エラー時は PRJ-{タイムスタンプ} を返す
}
```

### フロントエンド実装

**ファイル**: `src/utils/bigquery.ts`

**関数**: `createProject()` 内

```typescript
// 既存の案件IDから最大の番号を取得
let maxNumber = 0;
projects.forEach(p => {
  const match = p.project_id?.match(/^PRJ-(\d+)$/);
  if (match && match[1]) {
    const num = parseInt(match[1], 10);
    if (!isNaN(num) && num > maxNumber) {
      maxNumber = num;
    }
  }
});

const nextNumber = maxNumber + 1;
const projectId = `PRJ-${nextNumber}`;
```

## 制約事項

### 1. 重複の禁止

- 案件IDは主キーとして使用されるため、重複は許可されない
- 重複チェックが実装されており、既存のIDと重複する場合はエラーとなる

### 2. 変更不可

- 一度作成された案件IDは変更できない
- 案件IDは他のテーブル（セグメント、地点、メッセージ等）の外部キーとして参照されるため

### 3. 再利用不可

- 削除された案件のIDは再利用されない
- 連番は継続される（例: PRJ-1, PRJ-2, PRJ-3 が存在し、PRJ-2を削除しても、次の案件はPRJ-4となる）

## 特殊な案件ID

以下の形式の案件IDは自動採番の対象外です（手動で設定されたもの）：

| 形式 | 用途 | 例 |
|------|------|-----|
| `PRJ-SAMPLE-{番号}` | サンプルデータ | `PRJ-SAMPLE-0001` |
| `PRJ-DEMO-{番号}` | デモデータ | `PRJ-DEMO-001` |
| `PRJ-TEST-{番号}` | テストデータ | `PRJ-TEST-001` |

これらは自動採番の検索対象外のため、連番に影響しません。

## 採番の流れ

```
1. 案件作成リクエスト
   ↓
2. 既存案件の最大番号を取得
   ↓
3. 最大番号 + 1 を計算
   ↓
4. PRJ-{番号} 形式で案件IDを生成
   ↓
5. 重複チェック
   ↓
6. 案件をデータベースに保存
```

## トラブルシューティング

### 問題: 案件IDが連番にならない

**原因**: 
- 手動で特殊な形式のIDが設定された
- データベースに不正な形式のIDが存在する

**対処法**:
- データベースを確認し、`PRJ-\d+` 形式以外のIDを修正
- または、最大番号を手動で調整

### 問題: 案件IDの生成に失敗する

**原因**:
- データベースへのアクセスエラー
- 権限不足

**対処法**:
- エラーログを確認
- データベース接続を確認
- フォールバックID（タイムスタンプ形式）が使用される場合は、後で手動で修正

## 関連ドキュメント

- [権限管理仕様書](../security/AUTHORIZATION_SPECIFICATION.md) - 案件IDの採番規則（付録B）
- [BigQueryテーブル定義書](./BIGQUERY_TABLE_DEFINITIONS.md) - projectsテーブルの定義

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-01-13 | 1.0 | 初版作成 | 開発チーム |
