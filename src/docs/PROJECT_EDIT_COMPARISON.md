# 案件編集の2つのモード比較

## 概要

UNIVERSEGEOでは、案件の編集に2つのモードがあります：

1. **直接編集モード**（セグメント0件の案件）
2. **修正依頼モード**（セグメント1件以上の案件）

## モード比較表

| 項目 | 直接編集モード | 修正依頼モード |
|------|--------------|--------------|
| **適用条件** | セグメント0件 | セグメント1件以上 |
| **承認フロー** | 不要（即座に反映） | 必要（管理者承認） |
| **編集ボタン名** | 「編集」 | 「案件情報の修正依頼」 |
| **背景色** | 青紫（#5b5fff） | 白（アウトライン） |

## 編集可能フィールド比較

### 直接編集モード（セグメント0件）

編集登録作業がまだ始まっていないため、**一部の柔軟なフィールドのみ**編集可能：

| フィールド | 編集可否 | 理由 |
|-----------|---------|------|
| 広告主法人名 | ❌ | 案件の基本情報（変更すべきではない） |
| 代理店名 | ❌ | 案件の基本情報 |
| 訴求内容 | ❌ | 案件の基本情報 |
| **UNIVERSEサービスID** | ✅ | 柔軟に変更可能 |
| **UNIVERSEサービス名** | ✅ | 柔軟に変更可能 |
| 主担当者 | ❌ | システムが自動設定 |
| **副担当者** | ✅ | 柔軟に変更可能 |
| 配信開始日 | ❌ | 案件の基本情報 |
| 配信終了日 | ❌ | 案件の基本情報 |
| 備考 | ❌ | 修正依頼で変更すべき |

**編集可能: 3フィールド**

### 修正依頼モード（セグメント1件以上）

セグメント登録が始まっているため、承認フローを経由して**すべてのフィールド**を変更可能：

| フィールド | 編集可否 | 理由 |
|-----------|---------|------|
| **広告主法人名** | ✅ | 承認フロー経由で変更可能 |
| **代理店名** | ✅ | 承認フロー経由で変更可能 |
| **訴求内容** | ✅ | 承認フロー経由で変更可能 |
| **UNIVERSEサービスID** | ✅ | 承認フロー経由で変更可能 |
| **UNIVERSEサービス名** | ✅ | 承認フロー経由で変更可能 |
| **主担当者** | ✅ | 承認フロー経由で変更可能 |
| **副担当者** | ✅ | 承認フロー経由で変更可能 |
| **配信開始日** | ✅ | 承認フロー経由で変更可能 |
| **配信終了日** | ✅ | 承認フロー経由で変更可能 |
| **備考** | ✅ | 承認フロー経由で変更可能 |

**編集可能: 全10フィールド**

## ビジネスロジック

### なぜ2つのモードが存在するのか？

#### 直接編集モード（セグメント0件）の目的
- 案件登録直後の**初期設定段階**
- まだセグメントが登録されていないため、影響範囲が限定的
- 柔軟なフィールド（UNIVERSEサービス情報、副担当者）は自由に変更可能
- 基本情報（法人名、訴求内容、配信期間）は変更すべきではない

#### 修正依頼モード（セグメント1件以上）の目的
- セグメント登録が**進行中または完了**している状態
- 変更の影響範囲が大きいため、**管理者の承認**が必要
- すべてのフィールドを変更可能だが、承認フローを経由
- 変更履歴を記録し、トレーサビリティを確保

## UIの違い

### 直接編集モード

```
┌────────────────────────────────────┐
│ 案件概要                [編集]    │ ← 青紫ボタン
├────────────────────────────────────┤
│ 基本情報                          │
│  広告主法人名: ○○株式会社         │ ← 読み取り専用
│  主担当者: 営業A                  │ ← 読み取り専用
│  副担当者: [入力可能]             │ ← 編集可能
│                                    │
│ UNIVERSEサービス情報              │
│  サービスID: [入力可能]           │ ← 編集可能
│  サービス名: [入力可能]           │ ← 編集可能
└────────────────────────────────────┘
```

### 修正依頼モード

```
┌────────────────────────────────────┐
│ 案件概要   [案件情報の修正依頼]   │ ← アウトラインボタン
├────────────────────────────────────┤
│ 基本情報                          │
│  広告主法人名: ○○株式会社         │ ← 読み取り専用（ダイアログで変更）
│  主担当者: 営業A                  │ ← 読み取り専用（ダイアログで変更）
│  副担当者: 営業B                  │ ← 読み取り専用（ダイアログで変更）
└────────────────────────────────────┘

↓ ボタンクリック

┌────────────────────────────────────┐
│ 案件情報の修正依頼                │
├────────────────────────────────────┤
│ 修正内容を入力してください        │
│                                    │
│ 広告主法人名: [入力可能]          │ ← すべて編集可能
│ 代理店名: [入力可能]              │
│ 訴求内容: [入力可能]              │
│ UNIVERSEサービスID: [入力可能]    │
│ UNIVERSEサービス名: [入力可能]    │
│ 主担当者: [入力可能]              │
│ 副担当者: [入力可能]              │
│ 配信開始日: [入力可能]            │
│ 配信終了日: [入力可能]            │
│ 備考: [入力可能]                  │
│                                    │
│ 修正理由: [必須入力]              │
│                                    │
│        [キャンセル] [修正依頼を送信]│
└────────────────────────────────────┘
```

## 権限制御

### 営業ユーザー

| 条件 | 直接編集 | 修正依頼 |
|------|---------|---------|
| 自分が主担当の案件 | ✅ | ✅ |
| 自分が副担当の案件 | ✅ | ✅ |
| 他人の案件 | ❌ | ❌ |

### 管理者

| 条件 | 直接編集 | 修正依頼 |
|------|---------|---------|
| すべての案件 | ✅ | ✅ |

## 実装詳細

### 直接編集モードの判定

```typescript
// ProjectDetail.tsx 183-190行目
const handleStartEditProject = () => {
  setEditedProject({
    universe_service_id: project.universe_service_id || '',
    universe_service_name: project.universe_service_name || '',
    sub_person_in_charge: project.sub_person_in_charge || '',
  });
  setIsEditingProject(true);
};
```

### 修正依頼モードの判定

```typescript
// utils/editRequest.ts
export function requiresEditRequest(
  type: 'project',
  data: Project,
  allSegments?: Segment[]
): boolean {
  const projectSegments = allSegments?.filter(s => s.project_id === data.project_id) || [];
  return projectSegments.length >= 1; // セグメント1件以上で修正依頼が必要
}
```

### ボタン表示制御

```typescript
// ProjectDetail.tsx 277行目
{canEditProject(user, project) && canDirectEdit('project', project, segments) && !isEditingProject && (
  <Button onClick={handleStartEditProject}>編集</Button>
)}

// ProjectDetail.tsx 307行目
{onEditRequestCreate && canEditProject(user, project) && !canDirectEdit('project', project, segments) && (
  <Button onClick={() => setShowProjectEditDialog(true)}>案件情報の修正依頼</Button>
)}
```

## ユースケース

### ケース1: 案件登録直後にUNIVERSEサービス情報を追加

1. 営業Aが案件を登録（セグメント0件）
2. 「編集」ボタンをクリック
3. UNIVERSEサービスIDとサービス名を入力
4. 「保存」ボタンで即座に反映

### ケース2: セグメント登録後に法人名の誤りを修正

1. 営業Aが案件にセグメントを追加（セグメント1件以上）
2. 法人名の誤りに気づく
3. 「案件情報の修正依頼」ボタンをクリック
4. 修正依頼ダイアログで法人名を修正
5. 修正理由を記入して送信
6. 管理者が承認すると反映

### ケース3: 副担当者の変更（セグメント登録前）

1. 営業Aが案件を登録（セグメント0件）
2. 「編集」ボタンをクリック
3. 副担当者を「営業B」に変更
4. 「保存」ボタンで即座に反映

### ケース4: 配信期間の延長（セグメント登録後）

1. 営業Aが進行中の案件を開く（セグメント複数）
2. クライアントから配信期間延長の依頼
3. 「案件情報の修正依頼」ボタンをクリック
4. 配信終了日を延長
5. 修正理由「クライアント要望により期間延長」を記入
6. 管理者が承認すると反映

## 注意事項

### 直接編集モード
- ✅ 変更は即座に反映される
- ✅ 履歴は記録されない（直接更新）
- ⚠️ 重要フィールドは編集できない
- ⚠️ セグメント登録後は使用不可

### 修正依頼モード
- ✅ すべてのフィールドを変更可能
- ✅ 変更履歴が記録される
- ✅ 管理者による承認が必要
- ⚠️ 承認されるまで反映されない
- ⚠️ 承認待ちの間、他の修正依頼を控えるべき

## まとめ

- **セグメント0件** → 直接編集モード（一部フィールドのみ）
- **セグメント1件以上** → 修正依頼モード（全フィールド、承認必要）
- 2つのモードにより、柔軟性とガバナンスを両立
- 変更の影響範囲に応じて適切なモードを自動選択
