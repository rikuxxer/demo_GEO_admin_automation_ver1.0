# マニュアル（OperationGuide）実装と POST /api/projects 500 エラーの関係

## 結論

**マニュアル実装そのものが 500 エラーの原因ではありません。**  
500 はバックエンドの「project_id PRJ-1 が既に存在する」問題であり、マニュアルはフォームを「開く」だけで、**案件登録の送信（createProject / POST /api/projects）はユーザーが手動で行っています**。

「マニュアルを実装してからエラーが出る」ように見えるのは、主に次のどちらか（または両方）の可能性が高いです。

1. **マニュアルで案件登録フローを試す機会が増えた**  
   → もともとあったバックエンドの重複エラーに、マニュアル経由でよく当たるようになった。
2. **フロントのみデプロイされ、バックエンドのリトライ修正がまだデプロイされていない**  
   → マニュアル入りのフロントは新しく、バックエンドは古いイメージのままなので、同じ 500 が続く。

---

## 1. マニュアル側の動き（何をしているか）

### OperationGuide がやっていること

- **案件一覧ページへ遷移**（`onNavigate('projects')`）
- **「新規案件登録」→「手動で登録」のクリック**（DOM の `[data-tour="new-project-button"]` 等をクリック）
- **案件登録フォームを開く**（`onOpenForm('project-form')` → `setIsProjectFormOpen(true)`）

つまりマニュアルは「フォームを開く」までで、**フォーム入力や「登録」ボタンのクリックはユーザー操作**です。

### OperationGuide がやっていないこと

- **createProject の呼び出し**
- **POST /api/projects の送信**
- **フォームの自動送信や project_id の付与**

案件登録の API を叩いているのは、あくまで **ProjectForm の送信 → App の handleProjectSubmit → useProjectSystem の createProject → bigQueryService.createProject（fetch POST）** の流れだけです。

---

## 2. 案件登録が送信される経路（マニュアル有無で同じ）

```
ユーザーが「登録」をクリック
  → ProjectForm onSubmit
  → App handleProjectSubmit(projectData)
  → useProjectSystem createProject(projectData)
  → bigQueryService.createProject (USE_API 時は fetch POST /api/projects)
  → リクエストボディに project_id は含めない（バックエンドで自動採番）
```

マニュアルでフォームを開いても、この経路は「マニュアルなしで手動でフォームを開いて送信する」場合と同一です。  
**マニュアル実装によって、createProject の呼び方や送信データが変わる箇所はありません。**

---

## 3. 500 の本当の原因（バックエンド）

- バックエンドで **project_id 未指定時に `generateNextProjectId()` で PRJ-1 を採番**
- すでに **PRJ-1 が BigQuery に存在**している
- **createProject の重複チェックで「already exists」** → 500 で返している

対策として入れた「**重複時は最大5回まで再採番してリトライ**」する処理が、**現在動いている Cloud Run のイメージに含まれていない可能性**があります（古いイメージのままのため、マニュアル実装後にテストすると同じ 500 が目立つ、という状況になり得ます）。

---

## 4. マニュアル実装後にエラーが「出るように見える」理由の整理

| 要因 | 説明 |
|------|------|
| マニュアルで案件登録を試す回数が増えた | 案件登録フローをガイドに沿って何度も実行するため、従来からある「PRJ-1 重複」に当たりやすくなる。 |
| フロントだけ新しくデプロイされている | マニュアル入りのフロントは最新でも、バックエンドがリトライ修正入りイメージに更新されていないと 500 が続く。 |
| 因果の取り違え | 「マニュアルを入れたら 500 が出た」と見えても、原因はバックエンドの採番・重複とデプロイ状態。 |

---

## 5. 推奨アクション

1. **バックエンドのデプロイ状態を確認する**
   - Cloud Run のサービスが参照している **イメージ digest** を確認する。
   - リトライ処理を入れたコミット以降のビルドで作られたイメージか確認する。
   - 必要なら **現在の main からバックエンドを再ビルド・再デプロイ**し、リトライが効くイメージに更新する。

2. **ログで「リトライ」の有無を確認する**
   - POST /api/projects で 500 を再現したとき、Cloud Run のログに  
     `⚠️ project_id重複のため再採番します` や  
     `⚠️ project_id重複エラーを検知:` が出るか確認する。
   - 出ない場合は、現在のコンテナにはリトライ処理が入っていないと判断できる。

3. **マニュアル実装を疑う必要はない**
   - フロントの案件登録フロー（createProject の呼び方・送信データ）は、マニュアル有無で変わっていない。
   - 500 対応はバックエンドのイメージ更新と採番・重複対策で行う。

詳細な確認手順は以下を参照してください。

- [VERIFY_DEPLOYED_IMAGE_AND_RETRY.md](./VERIFY_DEPLOYED_IMAGE_AND_RETRY.md)
- [ERROR_ANALYSIS_500_AND_404.md](./ERROR_ANALYSIS_500_AND_404.md)
