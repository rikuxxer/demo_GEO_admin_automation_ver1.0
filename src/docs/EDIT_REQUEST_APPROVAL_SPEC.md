# 修正依頼・承認フロー仕様書

**バージョン:** 1.0  
**最終更新日:** 2024年12月  
**作成者:** 開発チーム

---

## 📋 目次

1. [概要](#概要)
2. [業務フロー](#業務フロー)
3. [データモデル](#データモデル)
4. [修正依頼の対象](#修正依頼の対象)
5. [権限設計](#権限設計)
6. [UI設計](#ui設計)
7. [ステータス管理](#ステータス管理)
8. [バリデーションルール](#バリデーションルール)
9. [通知仕様](#通知仕様)
10. [実装仕様](#実装仕様)

---

## 概要

### 目的
一度登録された案件・セグメント・地点情報を修正する際に、営業担当者が修正依頼を作成し、管理部が承認することで変更を反映させる。誤操作や不正な変更を防ぎ、データの整合性を保つ。

### 適用範囲
以下のステータス以降は修正依頼・承認フローが必要：
- **案件**: 配下にセグメントが1件以上存在する場合
- **セグメント**: 地点格納依頼後（`location_request_status = 'storing'` 以降）
- **地点**: 地点格納依頼後（セグメントの`location_request_status = 'storing'` 以降）

### 基本方針
1. **営業**: 修正依頼を作成（変更内容を記載）
2. **管理部**: ��頼を確認し、承認または却下
3. **承認時**: 自動的に変更内容が反映される
4. **却下時**: 却下理由を記載し、営業に通知

---

## 業務フロー

### 基本フロー

```
┌─────────────────────────────────────────────────┐
│ 1. 営業：修正が必要な項目を発見                   │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 2. 営業：修正依頼を作成                          │
│    ・修正対象（案件/セグメント/地点）を選択       │
│    ・変更内容を入力                              │
│    ・修正理由を記載                              │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 3. システム：修正依頼を登録                      │
│    ・ステータス: pending（承認待ち）             │
│    ・管理部に通知（メール/画面通知）              │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 4. 管理部：修正依頼を確認                        │
│    ・変更内容の妥当性をチェック                   │
│    ・必要に応じて営業に確認                      │
└─────────────────────────────────────────────────┘
                    ↓
        ┌───────────┴───────────┐
        │                       │
     承認                    却下
        │                       │
        ↓                       ↓
┌──────────────┐      ┌──────────────────┐
│ 5-A. 承認処理 │      │ 5-B. 却下処理     │
│ ・変更を適用  │      │ ・却下理由を記載  │
│ ・営業に通知  │      │ ・営業に通知      │
└──────────────┘      └──────────────────┘
```

---

## データモデル

### EditRequest テーブル

修正依頼の情報を管理するテーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| `request_id` | STRING | NO | 修正依頼ID（自動採番）`REQ_YYYYMMDD_XXXXX` |
| `request_type` | STRING | NO | 依頼種別（`project` / `segment` / `poi`） |
| `target_id` | STRING | NO | 修正対象のID（project_id / segment_id / poi_id） |
| `project_id` | STRING | NO | 案件ID（検索用） |
| `segment_id` | STRING | YES | セグメントID（segmentまたはpoiの場合のみ） |
| `requested_by` | STRING | NO | 依頼者（営業のuser_id） |
| `requested_at` | TIMESTAMP | NO | 依頼日時 |
| `request_reason` | STRING | NO | 修正理由 |
| `status` | STRING | NO | ステータス（`pending` / `approved` / `rejected`） |
| `changes` | JSON | NO | 変更内容（変更前後の値） |
| `reviewed_by` | STRING | YES | 承認/却下した管理者のuser_id |
| `reviewed_at` | TIMESTAMP | YES | 承認/却下日時 |
| `review_comment` | STRING | YES | 承認/却下時のコメント（却下理由など） |

#### changesフィールドの構造

```json
{
  "advertiser_name": {
    "before": "株式会社サンプル",
    "after": "株式会社サンプル商事"
  },
  "delivery_start_date": {
    "before": "2024-01-01",
    "after": "2024-01-15"
  }
}
```

### インデックス設計

```sql
-- 案件IDでの検索用
CREATE INDEX idx_edit_request_project ON edit_requests(project_id);

-- ステータスでの検索用（承認待ちリスト）
CREATE INDEX idx_edit_request_status ON edit_requests(status);

-- 依頼者での検索用（営業が自分の依頼を確認）
CREATE INDEX idx_edit_request_requester ON edit_requests(requested_by);

-- 複合インデックス（承認待ち一覧）
CREATE INDEX idx_edit_request_pending ON edit_requests(status, requested_at);
```

---

## 修正依頼の対象

### 【対象1】案件（Project）

#### 修正依頼が必要になる条件
```
配下のセグメント数 ≧ 1
```

#### 修正可能な項目
- ✅ 広告主法人名（`advertiser_name`）
- ✅ 代理店名（`agency_name`）
- ✅ 訴求内容（`appeal_point`）
- ✅ UNIVERSEサービスID/名（`universe_service_id`, `universe_service_name`）
- ✅ 配信開始日・終了日（`delivery_start_date`, `delivery_end_date`）
- ✅ 主担当者・副担当者（`person_in_charge`, `sub_person_in_charge`）
- ✅ 備考（`remarks`）

#### 修正不可な項目
- ❌ 案件ID（`project_id`）: システム自動採番
- ❌ 登録日（`_register_datetime`）: システム自動採番

---

### 【対象2】セグメント（Segment）

#### 修正依頼が必要になる条件
```
location_request_status = 'storing' または 'completed'
```

つまり、地点格納依頼を送信した後。

#### 修正可能な項目

**基本情報**:
- ✅ セグメント名（`segment_name`）
- ✅ 配信媒体（`media_id`）※要注意：TVer(CTV)の排他制御
- ✅ AdsアカウントID（`ads_account_id`）

**セグメント共通条件**:
- ✅ 指定半径（`designated_radius`）
- ✅ 抽出期間（`extraction_period`, `extraction_period_type`, `extraction_start_date`, `extraction_end_date`）
- ✅ 属性（`attribute`）
- ✅ 検知回数（`detection_count`）
- ✅ 検知時間帯（`detection_time_start`, `detection_time_end`）
- ✅ 滞在時間（`stay_time`）

#### 修正不可な項目
- ❌ セグメントID（`segment_id`）
- ❌ 案件ID（`project_id`）
- ❌ 登録日時（`segment_registered_at`）

#### 注意事項
セグメント共通条件を変更すると、配下の全地点に影響します。承認画面で警告を表示。

---

### 【対象3】地点（PoiInfo）

#### 修正依頼が必要になる条件
```
セグメントのlocation_request_status = 'storing' または 'completed'
```

#### 修正可能な項目
- ✅ 地点名（`poi_name`）
- ✅ 住所（`address`）
- ✅ 緯度・経度（`latitude`, `longitude`）
- ✅ 都道府県・市区町村（`prefectures`, `cities`）
- ✅ PKGカテゴリ（`pkg_category`）

#### 修正不可な項目
- ❌ セグメントID（`segment_id`）
- ❌ 地点ID（`poi_id`）
- ❌ 地点タイプ（`poi_type`）: タイプ変更は削除→再作成で対応

#### 注意事項
地点の座標を変更する場合、Geocoding APIで再検証します。

---

## 権限設計

### 営業（sales）の権限

| 操作 | 権限 | 制限事項 |
|------|------|---------|
| 修正依頼の作成 | ✅ 可能 | 自分が担当する案件のみ |
| 修正依頼の確認 | ✅ 可能 | 自分が作成した依頼のみ |
| 修正依頼の取り下げ | ✅ 可能 | 承認待ち（`pending`）のみ、自分の依頼のみ |
| 修正依頼の承認/却下 | ❌ 不可 | 管理部の権限 |

### 管理部（admin）の権限

| 操作 | 権限 | 制限事項 |
|------|------|---------|
| 修正依頼の作成 | ✅ 可能 | すべての案件 |
| 修正依頼の確認 | ✅ 可能 | すべての依頼 |
| 修正依頼の承認 | ✅ 可能 | すべての依頼 |
| 修正依頼の却下 | ✅ 可能 | すべての依頼（却下理由必須） |
| 修正依頼の取り下げ | ✅ 可能 | すべての依頼（承認待ちのみ） |
| 直接編集 | ✅ 可能 | 修正依頼を経由せず直接編集可能 |

---

## UI設計

### 1. 修正依頼作成ダイアログ

#### 表示タイミング
- 営業が編集不可な項目を編集しようとしたとき
- 「修正依頼」ボタンをクリックしたとき

#### UI構成

```
┌──────────────────────────────────────────┐
│ 🔧 修正依頼を作成                         │
├──────────────────────────────────────────┤
│                                          │
│ 修正対象:                                 │
│ 📋 案件: 株式会社サンプル - 新製品PR       │
│                                          │
│ 変更内容:                                 │
│ ┌────────────────────────────────────┐   │
│ │ 項目           変更前 → 変更後       │   │
│ │ 広告主法人名   株式会社サンプル          │   │
│ │               → 株式会社サンプル商事  │   │
│ │ 配信開始日     2024-01-01               │   │
│ │               → 2024-01-15           │   │
│ └────────────────────────────────────┘   │
│                                          │
│ 修正理由（必須）:                          │
│ ┌────────────────────────────────────┐   │
│ │ クライアントより社名変更の連絡があり    │   │
│ │ ました。配信開始日も調整が入りました。  │   │
│ └────────────────────────────────────┘   │
│                                          │
│ ⚠️ 承認されるまで変更は反映されません      │
│                                          │
│          [キャンセル]  [依頼を送信]       │
└──────────────────────────────────────────┘
```

---

### 2. 承認待ち一覧（管理部画面）

#### 画面構成

```
┌────────────────────────────────────────────────┐
│ 📬 修正依頼（承認待ち）                3件      │
├────────────────────────────────────────────────┤
│                                                │
│ フィルタ: [すべて ▼] [案件のみ] [セグメント] [地点]
│                                                │
│ ┌────────────────────────────────────────────┐ │
│ │ REQ_20241213_00001  📋 案件    2024-12-13  │ │
│ │ 株式会社サンプル - 新製品PR                 │ │
│ │ 依頼者: 山田太郎                            │ │
│ │ 理由: クライアントより社名変更の連絡        │ │
│ │                        [詳細を見る]        │ │
│ └────────────────────────────────────────────┘ │
│                                                │
│ ┌────────────────────────────────────────────┐ │
│ │ REQ_20241213_00002  📊 セグメント 2024-12-13│ │
│ │ 株式会社ABC - キャンペーンA / セグメント1   │ │
│ │ 依頼者: 佐藤花子                            │ │
│ │ 理由: 配信半径の誤りを修正                  │ │
│ │                        [詳細を見る]        │ │
│ └────────────────────────────────────────────┘ │
│                                                │
└────────────────────────────────────────────────┘
```

---

### 3. 修正依頼詳細・承認ダイアログ

#### UI構成

```
┌──────────────────────────────────────────────┐
│ 📋 修正依頼の詳細                             │
├──────────────────────────────────────────────┤
│                                              │
│ 依頼ID: REQ_20241213_00001                   │
│ 依頼日時: 2024-12-13 14:30                   │
│ 依頼者: 山田太郎（営業部）                    │
│                                              │
│ 修正対象:                                     │
│ 📋 案件: 株式会社サンプル - 新製品PR          │
│                                              │
│ 変更内容:                                     │
│ ┌──────────────────────────────────────────┐ │
│ │ 項目           変更前          変更後     │ │
│ │ 広告主法人名   株式会社サンプル             │ │
│ │               → 株式会社サンプル商事       │ │
│ │ 配信開始日     2024-01-01                  │ │
│ │               → 2024-01-15                │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│ 修正理由:                                     │
│ ┌──────────────────────────────��───────────┐ │
│ │ クライアントより社名変更の連絡がありました。│ │
│ │ 配信開始日も調整が入りました。              │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│ 管理者コメント（任意）:                       │
│ ┌──────────────────────────────────────────┐ │
│ │                                           │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│         [却下する]  [承認して変更を適用]      │
└──────────────────────────────────────────────┘
```

---

### 4. 営業の依頼履歴確認画面

#### 画面構成

案件詳細画面のタブに「修正依頼履歴」を追加。

```
┌────────────────────────────────────────────┐
│ [案件概要] [セグメント管理] [地点情報]      │
│ [修正依頼履歴] ← 新規追加                  │
├────────────────────────────────────────────┤
│                                            │
│ 📬 修正依頼履歴                             │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ ✅ REQ_20241210_00005  承認済           │ │
│ │ セグメント: セグメント1                 │ │
│ │ 依頼日: 2024-12-10  承認日: 2024-12-10  │ │
│ │ 変更内容: 指定半径 500m → 1000m         │ │
│ │ 承認者: 管理部 田中                     │ │
│ └────────────────────────────────────────┘ │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ ⏳ REQ_20241213_00001  承認待ち         │ │
│ │ 案件: 案件基本情報                      │ │
│ │ 依頼日: 2024-12-13                      │ │
│ │ 変更内容: 広告主法人名、配信開始日      │ │
│ │                        [取り下げる]    │ │
│ └────────────────────────────────────────┘ │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ ❌ REQ_20241211_00003  却下             │ │
│ │ セグメント: セグメント2                 │ │
│ │ 依頼日: 2024-12-11  却下日: 2024-12-12  │ │
│ │ 変更内容: 配信媒体変更                  │ │
│ │ 却下理由: TVer(CTV)は他媒体と併用不可   │ │
│ └────────────────────────────────────────┘ │
│                                            │
└────────────────────────────────────────────┘
```

---

## ステータス管理

### 修正依頼のステータス

| ステータス | 内部値 | 意味 |
|-----------|--------|------|
| 承認待ち | `pending` | 営業が依頼を作成し、管理部の確認待ち |
| 承認済み | `approved` | 管理部が承認し、変更が適用された |
| 却下 | `rejected` | 管理部が却下し、変更は適用されない |
| 取り下げ | `withdrawn` | 営業または管理部が依頼を取り下げ |

### ステータス遷移図

```
[pending]
   ↓
   ├─ 承認 → [approved]
   ├─ 却下 → [rejected]
   └─ 取り下げ → [withdrawn]

※ approved, rejected, withdrawn からの遷移はなし（終了状態）
```

---

## バリデーションルール

### 1. 修正依頼作成時

#### 必須チェック
- ✅ 変更内容が1つ以上存在する
- ✅ 修正理由が入力されている（100文字以上推奨）

#### ビジネスルールチェック
- ✅ 配信媒体変更時: TVer(CTV)の排他制御
- ✅ 配信期間変更時: 終了日 >= 開始日
- ✅ セグメント共通条件変更時: 属性が「居住者」「勤務者」の場合、抽出期間は3ヶ月固定

#### 権限チェック
- ✅ 営業: 自分が担当する案件のみ修正依頼可能
- ✅ 修正依頼が必要な状態か（セグメント数、格納依頼ステータス）

---

### 2. 承認時

#### 再バリデーション
承認時に依頼内容を再度検証：
- ✅ 変更内容が現在のデータと整合性があるか
- ✅ 他の修正依頼と競合していないか
- ✅ ビジネスルール違反がないか

#### 競合チェック

同じ項目に対する複数の修正依頼がある場合：
```
例: 
依頼A（pending）: 広告主名を「株式会社A」→「株式会社B」
依頼B（pending）: 広告主名を「株式会社A」→「株式会社C」

→ 先に承認された方を適用し、後の依頼は自動的に却下
```

---

### 3. 却下時

#### 必須項目
- ✅ 却下理由（必須）: 営業が修正内容を理解できるよう明確に記載

---

## 通知仕様

### 通知タイミング

| イベント | 通知先 | 通知内容 |
|---------|-------|---------|
| 修正依頼作成 | 管理部全員 | 「新しい修正依頼が届きました」 |
| 修正依頼承認 | 依頼者（営業） | 「修正依頼が承認されました」 |
| 修正依頼却下 | 依頼者（営業） | 「修正依頼が却下されました」+ 却下理由 |
| 修正依頼取り下げ | 管理部全員 | 「修正依頼が取り下げられました」 |

### 通知方法

#### Phase 1（初期実装）
- 画面内通知（ヘッダーのベルアイコン）
- 承認待ち件数のバッジ表示

#### Phase 2（将来実装）
- メール通知
- Slack通知連携

---

## 実装仕様

### 1. 型定義（schema.ts）

```typescript
// 修正依頼
export interface EditRequest {
  request_id: string;
  request_type: 'project' | 'segment' | 'poi';
  target_id: string;
  project_id: string;
  segment_id?: string;
  requested_by: string;
  requested_at: string;
  request_reason: string;
  status: 'pending' | 'approved' | 'rejected' | 'withdrawn';
  changes: Record<string, { before: any; after: any }>;
  reviewed_by?: string;
  reviewed_at?: string;
  review_comment?: string;
}

// 修正依頼ステータスの選択肢
export const EDIT_REQUEST_STATUS_OPTIONS = [
  { value: 'pending', label: '承認待ち', icon: 'Clock', color: 'yellow' },
  { value: 'approved', label: '承認済み', icon: 'CheckCircle2', color: 'green' },
  { value: 'rejected', label: '却下', icon: 'XCircle', color: 'red' },
  { value: 'withdrawn', label: '取り下げ', icon: 'MinusCircle', color: 'gray' },
] as const;
```

---

### 2. コンポーネント設計

#### 新規作成するコンポーネント

| ファイル名 | 役割 |
|-----------|------|
| `EditRequestForm.tsx` | 修正依頼作成フォーム |
| `EditRequestList.tsx` | 承認待ち一覧（管理部用） |
| `EditRequestDetail.tsx` | 修正依頼詳細・承認ダイアログ |
| `EditRequestHistory.tsx` | 修正依頼履歴（案件詳細タブ） |
| `EditRequestBadge.tsx` | 承認待ち件数バッジ |

#### 既存コンポーネントの修正

| ファイル名 | 修正内容 |
|-----------|---------|
| `ProjectForm.tsx` | 編集不可状態で「修正依頼」ボタンを表示 |
| `SegmentForm.tsx` | 編集不可状態で「修正依頼」ボタンを表示 |
| `PoiForm.tsx` | 編集不可状態で「修正依頼」ボタンを表示 |
| `Header.tsx` | 承認待ち件数バッジを追加 |
| `AdminDashboard.tsx` | 修正依頼一覧セクションを追加 |
| `ProjectDetail.tsx` | 「修正依頼履歴」タブを追加 |

---

### 3. ユーティリティ関数

```typescript
// /utils/editRequest.ts

/**
 * 修正依頼が必要な状態かチェック
 */
export function requiresEditRequest(
  type: 'project' | 'segment' | 'poi',
  data: any,
  allSegments?: Segment[]
): boolean;

/**
 * 変更内容をdiff形式に変換
 */
export function createChangeDiff(
  before: any,
  after: any
): Record<string, { before: any; after: any }>;

/**
 * 修正依頼を適用
 */
export function applyEditRequest(
  request: EditRequest,
  currentData: any
): any;

/**
 * 修正依頼の競合チェック
 */
export function checkEditRequestConflict(
  newRequest: EditRequest,
  pendingRequests: EditRequest[]
): boolean;
```

---

### 4. API設計（想定）

#### POST /api/edit-requests
修正依頼を作成

**リクエスト**:
```json
{
  "request_type": "project",
  "target_id": "PRJ_20241201_00001",
  "request_reason": "クライアントより社名変更の連絡",
  "changes": {
    "advertiser_name": {
      "before": "株式会社サンプル",
      "after": "株式会社サンプル商事"
    }
  }
}
```

**レスポンス**:
```json
{
  "success": true,
  "request_id": "REQ_20241213_00001"
}
```

---

#### GET /api/edit-requests
修正依頼一覧を取得

**クエリパラメータ**:
- `status`: pending / approved / rejected / withdrawn
- `requested_by`: 依頼者でフィルタ（営業用）
- `project_id`: 案件でフィルタ

---

#### POST /api/edit-requests/:request_id/approve
修正依頼を承認

**リクエスト**:
```json
{
  "review_comment": "承認しました"
}
```

---

#### POST /api/edit-requests/:request_id/reject
修正依頼を却下

**リクエスト**:
```json
{
  "review_comment": "TVer(CTV)は他媒体と併用できません"
}
```

---

## 今後の拡張

### Phase 2 機能
1. **一括承認**: 複数の修正依頼を一括で承認
2. **承認フローの段階化**: 営業マネージャー → 管理部の2段階承認
3. **変更履歴の詳細表示**: いつ誰がどの項目を変更したか完全な履歴
4. **差分プレビュー**: 変更前後をビジュアルに比較表示

### Phase 3 機能
1. **自動承認ルール**: 軽微な変更は自動承認（例: 備考のみの変更）
2. **条件付き承認**: 「〇〇を修正すれば承認」のようなフィードバック
3. **変更テンプレート**: よくある変更パターンをテンプレート化

---

## 参考ドキュメント

- [システム仕様書](./SYSTEM_SPECIFICATION.md)
- [テーブル定義書](./TABLE_DEFINITIONS.md)
- [権限設計書](./ROLE_PERMISSIONS.md)

---

**END OF DOCUMENT**
