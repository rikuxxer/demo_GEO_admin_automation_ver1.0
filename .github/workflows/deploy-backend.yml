name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGION: asia-northeast1
  SERVICE_NAME: universegeo-backend

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    
    # push ã®ã¨ãã¯ production æ‰±ã„ã€æ‰‹å‹•å®Ÿè¡Œã¯é¸æŠžå€¤
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required secrets
        run: |
          echo "ðŸ” å¿…é ˆSecretsã®ç¢ºèªä¸­..."
          test -n "${{ secrets.GCP_SA_KEY }}" || (echo "âŒ GCP_SA_KEY is missing" && exit 1)
          test -n "${{ secrets.BQ_DATASET }}" || (echo "âŒ BQ_DATASET is missing" && exit 1)
          test -n "${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}" || (echo "âŒ GCP_PROJECT_ID is missing" && exit 1)
          echo "âœ… å¿…é ˆSecretsãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          echo ""
          echo "ðŸ“‹ ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª:"
          echo "  Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "  GCP_PROJECT_ID: $([ -n "${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}" ] && echo 'âœ… SET' || echo 'âŒ NOT SET')"
          echo "  BQ_DATASET: $([ -n "${{ secrets.BQ_DATASET }}" ] && echo 'âœ… SET' || echo 'âŒ NOT SET')"
          echo "  GOOGLE_SPREADSHEET_ID: $([ -n "${{ secrets.GOOGLE_SPREADSHEET_ID }}" ] && echo 'âœ… SET' || echo 'âš ï¸ NOT SET')"
          echo "  FRONTEND_URL: $([ -n "${{ secrets.FRONTEND_URL }}" ] && echo 'âœ… SET' || echo 'âš ï¸ NOT SET')"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify Backend Files
        working-directory: ./backend
        run: |
          echo "ðŸ” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:"
          echo ""
          echo "ðŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
          ls -la
          echo ""
          echo "ðŸ“„ é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:"
          echo "  Dockerfile: $([ -f Dockerfile ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"
          echo "  package.json: $([ -f package.json ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"
          echo "  tsconfig.json: $([ -f tsconfig.json ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"
          echo "  src/index.ts: $([ -f src/index.ts ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ å­˜åœ¨ã—ãªã„')"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ env.SERVICE_NAME }}
          source: ./backend
          region: ${{ env.REGION }}
          project_id: ${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
          
          # é‡è¦: æ—¢å­˜ã® env ã‚’å£Šã•ãšè¿½åŠ æ›´æ–°
          env_vars_update_strategy: merge
          env_vars: |-
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
            BQ_DATASET=${{ secrets.BQ_DATASET }}
            GOOGLE_SPREADSHEET_ID=${{ secrets.GOOGLE_SPREADSHEET_ID }}
            GOOGLE_SHEETS_API_KEY=${{ secrets.GOOGLE_SHEETS_API_KEY }}
            GOOGLE_SHEET_NAME=${{ secrets.GOOGLE_SHEET_NAME }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
          
          flags: >-
            --allow-unauthenticated
            --memory 512Mi
            --cpu 1
            --max-instances 10
          
          # æ‰‹å‹•ã® update-traffic ã‚’æ¶ˆã™
          revision_traffic: 'LATEST=100'

      - name: Deployment Summary
        run: |
          echo "## âœ… Backend Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å…±æœ‰ï¼ˆç·¨é›†è€…æ¨©é™ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "ðŸš€ Backend deployed to: ${{ steps.deploy.outputs.url }}"
